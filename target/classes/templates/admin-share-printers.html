<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <th:block th:replace="fragments/head :: header"/>
    <title>Compartir Impresoras - PrintManager</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css"/>
    <link rel="stylesheet" th:href="@{/css/admin-sidebar.css}"/>
    <link rel="stylesheet" th:href="@{/css/admin-modern.css}"/>
    <link rel="stylesheet" th:href="@{/css/admin-departments.css}"/>
    <link rel="stylesheet" th:href="@{/css/admin-sidebar-override.css}"/>
    <link rel="stylesheet" th:href="@{/css/home.css}"/>
    <link rel="stylesheet" th:href="@{/css/notifications.css}"/>
</head>
<body>
    <nav th:replace="fragments/nav.html :: nav"></nav>
    <div th:if="${success}" class="alert alert-success alert-fixed">
        <span th:text="${success}"></span>
    </div>
    <div th:if="${error}" class="alert alert-error alert-fixed">
        <span th:text="${error}"></span>
    </div>

    <div class="admin-layout">
        <!-- Sidebar -->
        <aside th:replace="fragments/admin-sidebar.html :: sidebar"></aside>
        
        <!-- Contenido Principal -->
        <div class="admin-content">
            <div class="departments-container">
                <!-- Header -->
                <div class="departments-header">
                    <h1><i class="fas fa-share-alt"></i> Compartir Impresoras</h1>
                    <p>Comparte impresoras locales y configura clientes IPP</p>
                </div>
                
                <!-- Secci√≥n de Compartir Impresoras -->
                <div class="section-card full-width" style="background: white; border-radius: 12px; box-shadow: 0 2px 8px rgba(0,0,0,0.1); border: 1px solid #e2e8f0;">
                    <div class="section-body" style="padding: 2rem;">
                        <div class="sharing-tools">
                            <div class="tool-section">
                                <h3><i class="fas fa-desktop"></i> Compartir Impresora USB/Local</h3>
                                <p>Comparte una impresora conectada localmente a tu computadora con la red</p>
                                
                                <div class="os-tabs">
                                    <button class="os-tab active" data-os="windows"><i class="fab fa-windows"></i> Windows</button>
                                    <button class="os-tab" data-os="linux"><i class="fab fa-linux"></i> Linux</button>
                                </div>
                                
                                <div class="os-content active" id="windows-share">
                                    <div class="instructions">
                                        <h4> Configuraci√≥n Completa - Cliente USB en Segundo Plano:</h4>
                                        
                            
                                       <h4>Paso 1: Instalaci√≥n de Requerimientos</h4>
                                        <p ><strong>Requerimientos:</strong></p>
                                        <ol start="1" style="margin-bottom: 1.5rem;">
                                            <li>Java (si no est√° instalado) - Requerido para el cliente</li>
                                            <li>SumatraPDF - Para impresi√≥n silenciosa</li>
                                            <li>Cliente USB - Se descarga desde el servidor</li>
                                            <li>Configuraci√≥n de inicio autom√°tico - Se ejecutar√° al encender la PC</li>
                                        </ol>
                                        <h4>Paso 2: Descargar el Script</h4>
                                        <ol style="margin-bottom: 1.5rem;">
                                            <li>Descarga el script haciendo clic en el bot√≥n de abajo</li>
                                        </ol>
                                        
                                        <a href="/api/download/share-windows-script" class="btn btn-download" onclick="return downloadShareScript();" style="margin-bottom: 2rem;"><i class="fas fa-download"></i> Descargar Script de Compartir (.BAT)</a>
                                        
                                        <h4>Paso 3: Ejecutar el Script</h4>
                                        <ol start="2" style="margin-bottom: 1.5rem;">
                                            <li>Haz <strong>DOBLE CLIC</strong> en el archivo descargado (<code>compartir-impresora-windows.bat</code>)</li>
                                            <li>Se solicitar√°n permisos de administrador autom√°ticamente - <strong>acepta</strong></li>
                                            <li>El script buscar√° autom√°ticamente tus impresoras USB</li>
                                            <li><strong>Selecciona la impresora USB</strong> que deseas compartir del men√∫</li>
                                        </ol>

                                        

                                        <details style="margin-top: 1rem; border: 1px solid #e2e8f0; border-radius: 6px; padding: 1rem;">
                                            <summary style="cursor: pointer; font-weight: 600; "><i class="fas fa-cog"></i> Instalaci√≥n Manual de Requisitos (Opcional)</summary>
                                            <div >
                                                <p>Si prefieres instalar los requisitos manualmente antes de ejecutar el script:</p>
                                                
                                                <h5 >1. Instalar Java (Obligatorio)</h5>
                                                <p><strong>Opci√≥n A:</strong> Con Winget (recomendado - r√°pido)</p>
                                                <code class="command-block" style="display: block; background: #1e293b; color: #e2e8f0; padding: 0.75rem; border-radius: 4px; font-family: monospace; margin: 0.5rem 0;">winget install EclipseAdoptium.Temurin.21.JRE</code>
                                                
                                                <p ><strong>Opci√≥n B:</strong> Descarga manual</p>
                                                <ul>
                                                    <li><a href="https://www.java.com/es/download/" target="_blank" style="color: #3b82f6;">Java oficial</a></li>
                                                    <li><a href="https://aka.ms/download-jdk/microsoft-jdk-21-windows-x64.msi" target="_blank" style="color: #3b82f6;">Microsoft JDK 17</a></li>
                                                </ul>

                                                <h5 >2. Instalar SumatraPDF (Recomendado)</h5>
                                                <p>Para impresi√≥n completamente silenciosa sin di√°logos:</p>
                                                
                                                <p><strong>Opci√≥n A:</strong> Con Winget</p>
                                                <code class="command-block" style="display: block; background: #1e293b; color: #e2e8f0; padding: 0.75rem; border-radius: 4px; font-family: monospace; margin: 0.5rem 0;">winget install SumatraPDF.SumatraPDF</code>
                                                
                                                <p ><strong>Opci√≥n B:</strong> Descarga manual</p>
                                                <ul>
                                                    <li><a href="https://www.sumatrapdfreader.org/download-free-pdf-viewer" target="_blank" style="color: #3b82f6;">SumatraPDF oficial</a></li>
                                                </ul>
                                                
                                                <div style="background: #fef3c7; border-left: 3px solid #f59e0b; padding: 0.75rem; border-radius: 4px; margin-top: 1rem;">
                                                    <strong>üí° Nota:</strong> Sin SumatraPDF, el sistema usar√° Adobe Reader o PowerShell, que pueden ser m√°s lentos.
                                                </div>
                                            </div>
                                        </details>

                                        <details style="margin-top: 1rem; border: 1px solid #e2e8f0; border-radius: 6px; padding: 1rem;">
                                            <summary style="cursor: pointer; font-weight: 600; "><i class="fas fa-tools"></i> Control Manual del Cliente</summary>
                                            <div style="margin-top: 1rem; padding-left: 1rem;">
                                                <p>Despu√©s de la instalaci√≥n, el cliente se guarda en:</p>
                                                <code style="background: #f1f5f9; padding: 0.25rem 0.5rem; border-radius: 3px;">%APPDATA%\PrinterShare\</code>
                                                <p style="margin-top: 1rem;">Ruta completa t√≠pica:</p>
                                                <code style="background: #f1f5f9; padding: 0.25rem 0.5rem; border-radius: 3px;">C:\Users\TuUsuario\AppData\Roaming\PrinterShare\</code>
                                                
                                                <h4 >Iniciar en Segundo Plano</h4>
                                                <ol>
                                                    <li>Abre la carpeta <code>%APPDATA%\PrinterShare</code></li>
                                                    <li>Haz doble clic en: <code>start-client-hidden.vbs</code></li>
                                                    <li>El cliente se iniciar√° sin mostrar ventanas</li>
                                                </ol>

                                                <h4 > Ver Logs en Tiempo Real</h4>
                                                <ol>
                                                    <li>Abre la carpeta <code>%APPDATA%\PrinterShare</code></li>
                                                    <li>Haz doble clic en: <code>ver-logs.bat</code></li>
                                                    <li>Ver√°s los logs en vivo en una ventana</li>
                                                </ol>

                                                <h4 > Detener el Cliente</h4>
                                                <ol>
                                                    <li>Abre la carpeta <code>%APPDATA%\PrinterShare</code></li>
                                                    <li>Haz doble clic en: <code>stop-client.bat</code></li>
                                                </ol>

                                                <h4 >Iniciar con Ventana (Debug)</h4>
                                                <ol>
                                                    <li>Abre la carpeta <code>%APPDATA%\PrinterShare</code></li>
                                                    <li>Haz doble clic en: <code>start-client.bat</code></li>
                                                    <li>Ver√°s una ventana con logs en tiempo real</li>
                                                </ol>
                                            </div>
                                        </details>

                                        <div style="margin-top: 1.5rem; padding: 0.75rem; background: #fff3cd; border-left: 3px solid #ffc107; border-radius: 4px; font-size: 0.875rem;">
                                            <strong>‚ö†Ô∏è Importante:</strong> La computadora con la impresora USB debe estar <strong>encendida</strong> para que otros puedan imprimir.
                                        </div>
                                    </div>
                                </div>
                                
                                <div class="os-content" id="linux-share">
                                    <div class="instructions">
                                        <h4>Instrucciones para Linux:</h4>
                                        <ol>
                                            <li>Descarga el script bash haciendo clic en el bot√≥n de abajo</li>
                                            <li>Dale permisos de ejecuci√≥n: <code>chmod +x compartir-impresora-linux.sh</code></li>
                                            <li>Ejecuta con sudo: <code>sudo ./compartir-impresora-linux.sh</code></li>
                                            <li>Selecciona la impresora USB/Local que deseas compartir del men√∫</li>
                                            <li>El script configurar√° y registra en el servidor</li>
                                            <li>¬°Listo! Ya puedes ver la impresora en la red</li>
                                        </ol>
                                  
                                        <p style="margin-top: 1rem; padding: 0.75rem; background: #fff3cd; border-left: 3px solid #ffc107; border-radius: 4px; font-size: 0.875rem;">
                                            <strong>‚ö†Ô∏è Importante:</strong> La computadora con la impresora USB debe estar <strong>encendida</strong> y CUPS debe estar ejecut√°ndose.
                                        </p>
                                    </div>
                                    <a href="/api/download/share-linux-script" class="btn btn-download" onclick="return downloadShareLinuxScript();"><i class="fas fa-download"></i> Descargar Script Linux (.SH)</a>
                                </div>
                            </div>
                            
                                                        <div class="tool-section">
                                <h3><i class="fas fa-network-wired"></i> Configurar Impresora IPP en Cliente</h3>
                                <p>Configura una computadora cliente para usar las impresoras compartidas</p>
                                
                                <div class="ipp-config">
                                    <label>1. Selecciona el departamento:</label>
                                    <select id="departmentSelect" class="form-control" style="margin-bottom: 1rem;">
                                        <option value="">-- Selecciona un departamento --</option>
                                        <option value="all">Todas las impresoras</option>
                                    </select>
                                    
                                    <label>2. Selecciona la impresora:</label>
                                    <select id="printerSelect" class="form-control">
                                        <option value="">-- Primero selecciona un departamento --</option>
                                    </select>
                                    
                                    <div id="ippInstructions" style="display:none; margin-top: 1rem;">
                                        <div class="info-box">
                                            <strong>URL IPP:</strong>
                                            <code id="ippUrl" class="selectable"></code>
                                            <button class="btn-copy" onclick="copyToClipboard('ippUrl', event)"><i class="fas fa-copy"></i> Copiar</button>
                                        </div>
                                        
                                        <div class="client-tabs">
                                            <button class="client-tab active" data-client="windows-client"><i class="fab fa-windows"></i> Windows</button>
                                            <button class="client-tab" data-client="linux-client"><i class="fab fa-linux"></i> Linux</button>
                                            <button class="client-tab" data-client="macos-client"><i class="fab fa-apple"></i> macOS</button>
                                        </div>
                                        
                                        <div class="client-content active" id="windows-client">
                                            <h4>Windows:</h4>
                                            
                                            <div>
                                                <h4>M√©todo Recomendado: Script Autom√°tico (.BAT)</h4>
                                                <p >La forma m√°s f√°cil y r√°pida de instalar la impresora:</p>
                                                <ol>
                                                    <li>Descarga el script BAT haciendo clic en el bot√≥n de abajo</li>
                                                    <li>Haz <strong>DOBLE CLIC </strong> en el archivo <code>.bat</code> descargado</li>
                                                    <li>Se solicitar√°n permisos de administrador autom√°ticamente</li>
                                                    <li>La impresora se instalar√° autom√°ticamente en 10-15 segundos</li>
                                                    <li>¬°Listo! Ya puedes imprimir</li>
                                                </ol>
                                            </div>
                                            
                                            <button class="btn btn-download" onclick="downloadWindowsClientScript()" >
                                                <i class="fas fa-download"></i> Descargar Script Autom√°tico (.BAT)
                                            </button>
                                        
                                            
                                    
                                            
                                            <details style="margin-top: 1.5rem;">
                                                <summary >üìã Instalaci√≥n Manual (si prefieres hacerlo sin el script)</summary>
                                                <ol>
                                                    <li>Abre "Configuraci√≥n" ‚Üí "Dispositivos" ‚Üí "Impresoras y esc√°neres"</li>
                                                    <li>Haz clic en "Agregar impresora o esc√°ner"</li>
                                                    <li>Selecciona "La impresora que deseo no est√° en la lista"</li>
                                                    <li>Selecciona "Seleccionar una impresora compartida por nombre"</li>
                                                    <li>Ingresa la URL IPP mostrada arriba</li>
                                                    <li>Instala los controladores cuando se solicite</li>
                                                </ol>
                                            </details>
                                        </div>
                                        
                                        <div class="client-content" id="linux-client">
                                            <h4>Linux:</h4>
                                            
                                            <div>
                                                <h4>M√©todo Recomendado: Script Autom√°tico (.SH)</h4>
                                                <p>La forma m√°s f√°cil y r√°pida de instalar la impresora:</p>
                                                <ol>
                                                    <li>Descarga el script Bash haciendo clic en el bot√≥n de abajo</li>
                                                    <li>Dale permisos de ejecuci√≥n: <code>chmod +x instalar-impresora-ipp.sh</code></li>
                                                    <li>Ejecuta el script: <code>./instalar-impresora-ipp.sh</code></li>
                                                    <li>Selecciona la impresora del men√∫ interactivo</li>
                                                    <li>La impresora se instalar√° autom√°ticamente con IPP Everywhere</li>
                                                    <li>¬°Listo! Ya puedes imprimir con PDF directo</li>
                                                </ol>
                                            </div>
                                            
                                            <button class="btn btn-download" onclick="downloadLinuxClientScript()" style="margin-bottom: 1.5rem;">
                                                <i class="fas fa-download"></i> Descargar Script Autom√°tico (.SH)
                                            </button>
                                            
                                            <details style="margin-top: 1.5rem;">
                                                <summary>üìã Instalaci√≥n Manual (si prefieres hacerlo sin el script)</summary>
                                                <ol>
                                                    <li>Abre "Configuraci√≥n del sistema" ‚Üí "Impresoras"</li>
                                                    <li>Haz clic en "Agregar" o "+"</li>
                                                    <li>Selecciona "Impresora de red" ‚Üí "Impresora IPP"</li>
                                                    <li>Ingresa la URL IPP mostrada arriba</li>
                                                </ol>
                                                <p><strong>O usa este comando:</strong></p>
                                                <code class="command-block selectable" id="linuxCommand"></code>
                                                <button class="btn-copy" onclick="copyToClipboard('linuxCommand', event)"><i class="fas fa-copy"></i> Copiar</button>
                                            </details>
                                        </div>
                                        
                                        <div class="client-content" id="macos-client">
                                            <h4>macOS:</h4>
                                            
                                            
                                            <div>
                                                <h4>M√©todo 1: Instalaci√≥n Autom√°tica (Recomendado)</h4>
                                                <ol>
                                                    <li>Abre "Preferencias del Sistema" ‚Üí "Impresoras y Esc√°neres"</li>
                                                    <li>Haz clic en el bot√≥n <strong>"+"</strong> para agregar una impresora</li>
                                                    <li>Espera a que macOS detecte autom√°ticamente la impresora IPP</li>
                                                    <li>Si aparece en la lista, selecci√≥nala y haz clic en "Agregar"</li>
                                                    <li>macOS seleccionar√° autom√°ticamente el driver <strong>AirPrint</strong> (PDF directo)</li>
                                                </ol>
                                                
                                                <p style="margin-top: 1rem; padding: 0.75rem; background: #d1fae5; border-left: 3px solid #10b981; border-radius: 4px; font-size: 0.875rem;">
                                                    <strong>‚úÖ Ventaja:</strong> AirPrint env√≠a PDF directamente con formato completo (colores, negritas, im√°genes)
                                                </p>
                                            </div>
                                            
                                            <details style="margin-top: 1.5rem;">
                                                <summary>üìã M√©todo 2: Instalaci√≥n Manual Avanzada</summary>
                                                <div style="margin-top: 1rem;">
                                                    <p>Si la impresora no aparece autom√°ticamente:</p>
                                                    <ol>
                                                        <li>Abre "Preferencias del Sistema" ‚Üí "Impresoras y Esc√°neres"</li>
                                                        <li>Haz clic en el bot√≥n <strong>"+"</strong></li>
                                                        <li><strong>Mant√©n presionada la tecla "Option" (‚å•)</strong> y haz clic en "Avanzado"</li>
                                                        <li>En "Tipo", selecciona <strong>"Internet Printing Protocol - IPP"</strong></li>
                                                        <li>En "URL", pega la URL IPP mostrada arriba</li>
                                                        <li>En "Nombre", ponle un nombre descriptivo a la impresora</li>
                                                        <li>En "Usar", selecciona una de estas opciones:
                                                            <ul style="margin-left: 2rem; margin-top: 0.5rem;">
                                                                <li><strong>Opci√≥n 1 (Recomendada):</strong> "Generic PostScript Printer" - Para documentos con formato</li>
                                                                <li><strong>Opci√≥n 2:</strong> "Generic PCL Printer" - Compatible con la mayor√≠a de impresoras</li>
                                                                <li><strong>Opci√≥n 3:</strong> Buscar el modelo espec√≠fico si aparece en la lista</li>
                                                                <li><strong>Opci√≥n 4:</strong> "AirPrint" - Si est√° disponible (mejor calidad)</li>
                                                            </ul>
                                                        </li>
                                                        <li>Haz clic en "Agregar"</li>
                                                    </ol>
                                                    
                                                    <div style="margin-top: 1rem; padding: 0.75rem; background: #fef3c7; border-left: 3px solid #f59e0b; border-radius: 4px; font-size: 0.875rem;">
                                                        <strong>‚ö†Ô∏è Importante:</strong>
                                                        <ul style="margin-left: 1.5rem; margin-top: 0.5rem;">
                                                            <li>NO uses "Generic Text Only" - perder√°s el formato</li>
                                                            <li>Si la impresora es <strong>Epson</strong>, busca drivers Epson en la lista</li>
                                                            <li>Si es <strong>HP</strong>, busca drivers HP en la lista</li>
                                                            <li>Si es <strong>Brother</strong>, busca drivers Brother en la lista</li>
                                                            <li>Si no encuentras el modelo, usa "Generic PostScript Printer"</li>
                                                        </ul>
                                                    </div>
                                                </div>
                                            </details>
                                            
                                            <details style="margin-top: 1rem;">
                                                <summary>üíª M√©todo 3: L√≠nea de Comandos (Terminal)</summary>
                                                <div style="margin-top: 1rem;">
                                                    <p>Para usuarios avanzados:</p>
                                                    <code class="command-block" style="display: block; background: #1e293b; color: #e2e8f0; padding: 1rem; border-radius: 4px; font-family: monospace; font-size: 0.875rem; overflow-x: auto; margin: 1rem 0;">
# Reemplaza los valores entre &lt; &gt;<br>
lpadmin -p "&lt;NOMBRE_IMPRESORA&gt;" \<br>
&nbsp;&nbsp;-v "<span id="macIppUrl"></span>" \<br>
&nbsp;&nbsp;-P "/System/Library/Frameworks/ApplicationServices.framework/Versions/A/Frameworks/PrintCore.framework/Resources/Generic.ppd" \<br>
&nbsp;&nbsp;-E
                                                    </code>
                                                    <p style="font-size: 0.875rem; color: #64748b;"><strong>Ejemplo:</strong></p>
                                                    <code class="command-block" style="display: block; background: #1e293b; color: #e2e8f0; padding: 1rem; border-radius: 4px; font-family: monospace; font-size: 0.875rem; overflow-x: auto;">
lpadmin -p "EPSON-Oficina" \<br>
&nbsp;&nbsp;-v "ipp://10.1.1.47:8633/printers/EPSON-THnomina" \<br>
&nbsp;&nbsp;-P "/System/Library/Frameworks/ApplicationServices.framework/Versions/A/Frameworks/PrintCore.framework/Resources/Generic.ppd" \<br>
&nbsp;&nbsp;-E
                                                    </code>
                                                </div>
                                            </details>
                                            
                                          
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Barra de progreso minimizada GLOBAL -->
    <div th:replace="fragments/scan-progress-minimized.html :: minimized-bar"></div>

    <script th:src="@{/js/admin.js}"></script>
    <script th:src="@{/js/scan-monitor-global.js}"></script>
    <script th:src="@{/js/notifications.js}"></script>
    <script th:src="@{/js/home-printer-sharing.js}"></script>
        <script>
        // Variables globales para almacenar todos los datos
        let allPrinters = [];
        let allDepartments = [];
        let serverIp = '';
        
        // Cargar departamentos e impresoras desde la API al cargar la p√°gina
        document.addEventListener('DOMContentLoaded', function() {
            loadDepartments();
        });
        
        async function loadDepartments() {
            try {
                // Cargar departamentos
                const deptResponse = await fetch('/api/departments');
                const deptData = await deptResponse.json();
                allDepartments = deptData.departments || [];
                
                // Cargar todas las impresoras
                const printersResponse = await fetch('/api/printers');
                const printersData = await printersResponse.json();
                allPrinters = printersData.printers || [];
                serverIp = printersData.serverIp;
                
                // Poblar el selector de departamentos
                const deptSelect = document.getElementById('departmentSelect');
                deptSelect.innerHTML = '<option value="">-- Selecciona un departamento --</option>';
                deptSelect.innerHTML += '<option value="all">Todas las impresoras</option>';
                
                allDepartments.forEach(dept => {
                    const option = document.createElement('option');
                    option.value = dept.id;
                    option.textContent = dept.name + ' (' + dept.totalPrinters + ' impresoras)';
                    deptSelect.appendChild(option);
                });
                
                // Agregar listener para cambio de departamento
                deptSelect.addEventListener('change', function() {
                    if (this.value === '') {
                        // No hay selecci√≥n
                        const printerSelect = document.getElementById('printerSelect');
                        printerSelect.innerHTML = '<option value="">-- Primero selecciona un departamento --</option>';
                        document.getElementById('ippInstructions').style.display = 'none';
                    } else if (this.value === 'all') {
                        // Todas las impresoras
                        loadAllPrinters();
                    } else {
                        // Cargar impresoras del departamento seleccionado
                        loadPrintersByDepartment(this.value);
                    }
                });
                
            } catch (error) {
                console.error('‚ùå Error cargando departamentos:', error);
                showError('Error cargando departamentos: ' + error.message);
            }
        }
        
        function loadAllPrinters() {
            const select = document.getElementById('printerSelect');
            select.innerHTML = '<option value="">-- Selecciona una impresora --</option>';
            
            allPrinters.forEach(printer => {
                const option = document.createElement('option');
                option.value = printer.id;
                option.textContent = printer.alias;
                option.dataset.ippuri = printer.ippUri;
                option.dataset.name = printer.alias;
                option.dataset.location = printer.location || '';
                select.appendChild(option);
            });
        }
        
        async function loadPrintersByDepartment(departmentId) {
            try {
                const response = await fetch('/api/departments/' + departmentId + '/printers');
                const data = await response.json();
                
                const select = document.getElementById('printerSelect');
                select.innerHTML = '<option value="">-- Selecciona una impresora --</option>';
                
                if (data.printers && data.printers.length > 0) {
                    data.printers.forEach(printer => {
                        const option = document.createElement('option');
                        option.value = printer.id;
                        option.textContent = printer.alias;
                        option.dataset.ippuri = printer.ippUri;
                        option.dataset.name = printer.alias;
                        option.dataset.location = printer.location || '';
                        select.appendChild(option);
                    });
                } else {
                    select.innerHTML = '<option value="">-- Este departamento no tiene impresoras asignadas --</option>';
                }
                
                // Ocultar instrucciones hasta que se seleccione una impresora
                document.getElementById('ippInstructions').style.display = 'none';
                
            } catch (error) {
                console.error('‚ùå Error cargando impresoras del departamento:', error);
                showError('Error cargando impresoras: ' + error.message);
            }
        }
        
        function downloadShareScript() {
            // Iniciar descarga
            window.location.href = '/api/download/share-windows-script';
            
            // Mostrar instrucciones mejoradas
            setTimeout(() => {
                showSuccess('Script descargado correctamente', 'Descarga Completa');
                setTimeout(() => {
                    showInfo(
                        '<strong>‚úÖ Instrucciones Simples:</strong><br><br>' +
                        '<strong>1. Haz DOBLE CLIC</strong> en el archivo descargado: <code>compartir-impresora-windows.bat</code><br>' +
                        '<strong>2. Se solicitar√°n permisos</strong> de administrador autom√°ticamente - acepta<br>' +
                        '<strong>3. Selecciona la impresora USB</strong> que deseas compartir del men√∫<br>' +
                        '<strong>4. El script</strong> la configurar√° y registrar√° autom√°ticamente<br>' +
                        '<strong>5. ¬°Listo!</strong> La impresora estar√° disponible en la red<br><br>' +
                        '<strong>üí° Qu√© hace el script:</strong><br>' +
                        '‚úÖ Detecta todas tus impresoras USB/Locales<br>' +
                        '‚úÖ Comparte la impresora en la red (SMB)<br>' +
                        '‚úÖ La registra en el servidor central<br>' +
                        '‚úÖ Configura el firewall autom√°ticamente<br>' +
                        '‚úÖ Asigna un puerto IPP √∫nico<br><br>' +
                        '<strong>‚ö†Ô∏è Importante:</strong> La PC con la impresora debe estar encendida para que otros puedan imprimir',
                        'C√≥mo usar el script'
                    );
                }, 800);
            }, 500);
            
            return false; // Prevenir navegaci√≥n adicional
        }
        
        function downloadShareLinuxScript() {
            // Iniciar descarga
            window.location.href = '/api/download/share-linux-script';
            
            // Mostrar instrucciones mejoradas
            setTimeout(() => {
                showSuccess('Script descargado correctamente', 'Descarga Completa');
                setTimeout(() => {
                    showInfo(
                        '<strong>‚úÖ Instrucciones Simples:</strong><br><br>' +
                        '<strong>1. Abre una terminal</strong> en la carpeta donde descargaste el script<br>' +
                        '<strong>2. Dale permisos:</strong> <code>chmod +x compartir-impresora-linux.sh</code><br>' +
                        '<strong>3. Ejecuta el script:</strong> <code>sudo ./compartir-impresora-linux.sh</code><br>' +
                        '<strong>4. Selecciona la impresora USB</strong> que deseas compartir del men√∫<br>' +
                        '<strong>5. ¬°Listo!</strong> La impresora estar√° disponible en la red<br><br>' +
                        '<strong>üí° Qu√© hace el script:</strong><br>' +
                        '‚úÖ Detecta todas tus impresoras CUPS locales<br>' +
                        '‚úÖ Comparte la impresora v√≠a IPP/CUPS<br>' +
                        '‚úÖ La registra en el servidor central<br>' +
                        '‚úÖ Configura el firewall autom√°ticamente<br>' +
                        '‚úÖ Asigna un puerto IPP √∫nico<br><br>' +
                        '<strong>‚ö†Ô∏è Importante:</strong> CUPS debe estar instalado y la PC debe estar encendida',
                        'C√≥mo usar el script'
                    );
                }, 800);
            }, 500);
            
            return false; // Prevenir navegaci√≥n adicional
        }
    </script>
</body>
</html>
