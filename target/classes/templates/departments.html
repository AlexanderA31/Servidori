<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <th:block th:replace="fragments/head :: header"/>
    <title>Gesti√≥n de Departamentos</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css"/>
    <link rel="stylesheet" th:href="@{/css/admin-sidebar.css}"/>
    <link rel="stylesheet" th:href="@{/css/admin-modern.css}"/>
    <link rel="stylesheet" th:href="@{/css/departments.css}"/>
</head>
<body>
    <nav th:replace="fragments/nav.html :: nav"></nav>
    
    <div th:if="${success}" class="alert alert-success alert-fixed">
        <span th:text="${success}"></span>
    </div>
    <div th:if="${error}" class="alert alert-error alert-fixed">
        <span th:text="${error}"></span>
    </div>

    <div class="admin-layout">
        <!-- Sidebar -->
        <aside th:replace="fragments/admin-sidebar.html :: sidebar"></aside>
        
        <!-- Contenido Principal -->
        <div class="admin-content">
    <div class="departments-container">
        <!-- Header con IP del Servidor -->
     

        <!-- Estad√≠sticas -->
        <div class="stats-grid">
            <div class="stat-card">
                <div class="stat-icon"><i class="fas fa-building"></i></div>
                <div class="stat-value" th:text="${departments != null ? #lists.size(departments) : 0}">0</div>
                <div class="stat-label">Departamentos</div>
            </div>
            <div class="stat-card">
                <div class="stat-icon"><i class="fas fa-desktop"></i></div>
                <div class="stat-value" th:text="${unassignedComputers != null ? #lists.size(unassignedComputers) : 0}">0</div>
                <div class="stat-label">Computadoras Sin Asignar</div>
            </div>
            <div class="stat-card">
                <div class="stat-icon"><i class="fas fa-print"></i></div>
                <div class="stat-value" th:text="${allPrinters != null ? #lists.size(allPrinters) : 0}">0</div>
                <div class="stat-label">Impresoras Disponibles</div>
            </div>
        </div>

        <!-- Lista de Todas las Impresoras -->
        <div class="card printers-card">
            <div class="card-header">
                <span><i class="fas fa-print"></i> Todas las Impresoras del Sistema</span>
                <div class="card-header-buttons">
                    <button class="btn btn-primary btn-sm" onclick="openModal('configureNetworksModal')">
                        <i class="fas fa-cog"></i> Configurar Redes
                    </button>
                    <form method="post" th:action="@{/admin/discover-printers}" class="d-inline">
                        <button type="submit" class="btn btn-primary btn-sm" 
                                onclick="return confirm('‚úÖ Escanear la red en busca de impresoras:\n\nüåê Redes (VLANs): 192.168.x.x, 10.0.x.x\nüñ®Ô∏è USB y Compartidas\n\n‚è±Ô∏è Tiempo estimado: 2-5 minutos\n\n¬øContinuar?')">
                            <i class="fas fa-sync"></i> Escanear Red
                        </button>
                    </form>
                    <button class="btn btn-primary btn-sm" onclick="openModal('addPrinterModal')">
                        <i class="fas fa-plus"></i> Agregar Manual
                    </button>
                </div>
            </div>
            <div class="card-body">
                <div th:if="${allPrinters == null || #lists.isEmpty(allPrinters)}" class="empty-state">
                    <div class="empty-state-icon"><i class="fas fa-print"></i></div>
                    <p>No hay impresoras registradas en el sistema</p>
                    <button class="btn btn-primary" onclick="openModal('addPrinterModal')">
                        <i class="fas fa-plus"></i> Agregar Primera Impresora
                    </button>
                </div>
                
                <div th:unless="${allPrinters == null || #lists.isEmpty(allPrinters)}">
                    <!-- Secci√≥n: Tabla de Impresoras -->
                    <table class="data-table">
                        <thead>
                            <tr>
                                <th>Impresora</th>
                                <th>Modelo</th>
                                <th>Ubicaci√≥n</th>
                                <th>Direcci√≥n IP</th>
                                <th>URI</th>
                                <th>Acciones</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr th:each="printer : ${allPrinters}">
                                <td>
                                    <strong>üñ®Ô∏è <span th:text="${printer.alias}">Impresora</span></strong>
                                </td>
                                <td th:text="${printer.model}">Modelo</td>
                                <td th:text="${printer.location}">Ubicaci√≥n</td>
                                <td>
                                    <span class="ip-badge" th:text="${printer.ip}">IP</span>
                                </td>
                                <td>
                                    <code th:if="${printer.deviceUri}" th:text="${printer.deviceUri}">URI</code>
                                    <span th:unless="${printer.deviceUri}" class="text-muted">--</span>
                                </td>
                                <td>
                                    <div class="action-buttons">
                                        <button class="btn btn-sm btn-primary" 
                                                th:attr="data-id=${printer.id}, data-alias=${printer.alias}, data-model=${printer.model}, data-location=${printer.location}, data-ip=${printer.ip}"
                                                onclick="openEditPrinterModal(this.dataset)">
                                            ‚úèÔ∏è
                                        </button>
                                        <form method="post" th:action="@{/admin/test-printer(id=${printer.id})}" 
                                              class="d-inline" 
                                              onsubmit="return confirm('üñ®Ô∏è ¬øEnviar p√°gina de prueba a: ' + this.dataset.name + '?')" 
                                              th:attr="data-name=${printer.alias}">
                                            <button type="submit" class="btn btn-sm btn-primary">
                                                üß™
                                            </button>
                                        </form>
                                        <form method="post" th:action="@{/admin/delete-printer(id=${printer.id})}" 
                                              class="d-inline" 
                                              onsubmit="return confirm('‚ö†Ô∏è ¬øEliminar impresora: ' + this.dataset.name + '?')" 
                                              th:attr="data-name=${printer.alias}">
                                            <button type="submit" class="btn btn-sm btn-primary">
                                                üóëÔ∏è
                                            </button>
                                        </form>
                                    </div>
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

        <!-- Secci√≥n de Departamentos -->
        <div class="card">
            <div class="card-header">
                <span>üìã Departamentos</span>
                <button class="btn btn-primary btn-sm" onclick="openModal('createDepartmentModal')">
                    ‚ûï Nuevo Departamento
                </button>
            </div>
            <div class="card-body">
                <div th:if="${departments == null || #lists.isEmpty(departments)}" class="empty-state">
                    <div class="empty-state-icon">üè¢</div>
                    <p>No hay departamentos creados</p>
                    <button class="btn btn-primary" onclick="openModal('createDepartmentModal')">
                        Crear Primer Departamento
                    </button>
                </div>

                <div th:unless="${departments == null || #lists.isEmpty(departments)}">
                    <!-- Secci√≥n: Tabla de Departamentos -->
                    <table class="data-table">
                        <thead>
                            <tr>
                                <th>Departamento</th>
                                <th>Descripci√≥n</th>
                                <th>Ubicaci√≥n</th>
                                <th>Computadoras</th>
                                <th>Impresoras</th>
                                <th>Acciones</th>
                            </tr>
                        </thead>
                        <tbody>
                    <tr th:each="dept : ${departments}" 
                         th:style="'border-left: 4px solid ' + ${dept.color}">
                                <td>
                                    <div class="dept-name-cell">
                                        <span class="dept-color-dot" th:style="'background: ' + ${dept.color}"></span>
                                        <strong th:text="${dept.name}">Departamento</strong>
                                    </div>
                                </td>
                                <td th:text="${dept.description}">Descripci√≥n</td>
                                <td>
                                    <span th:if="${dept.location}" th:text="${dept.location}">Ubicaci√≥n</span>
                                    <span th:unless="${dept.location}" class="text-muted">--</span>
                                </td>

                                <td>
                                    <div>
                                        <strong th:text="${dept.computers != null ? #lists.size(dept.computers) : 0}">0</strong>
                                        <button class="btn btn-sm btn-primary" 
                                                th:attr="data-dept-id=${dept.id}, data-dept-name=${dept.name}"
                                                onclick="openAddComputerModal(this.dataset)"
                                                title="Agregar computadora">‚ûï</button>
                                    </div>
                                    <div th:if="${dept.computers != null and #lists.size(dept.computers) > 0}" class="dept-items-container">
                                        <div th:each="comp : ${dept.computers}" class="badge badge-secondary dept-item-badge">
                                            <span th:text="${comp.name}">PC</span>
                                        </div>
                                    </div>
                                </td>
                                <td>
                                    <div>
                                        <strong th:text="${dept.printers != null ? #lists.size(dept.printers) : 0}">0</strong>
                                        <button class="btn btn-sm btn-primary" 
                                                th:attr="data-dept-id=${dept.id}, data-dept-name=${dept.name}"
                                                onclick="openAssignPrinterModal(this.dataset)"
                                                title="Asignar impresora">‚ûï</button>
                                    </div>
                                                                          <div th:if="${dept.printers != null and #lists.size(dept.printers) > 0}" class="dept-items-container">
                                          <div th:each="printer : ${dept.printers}" class="dept-printer-item">
                                              <span class="printer-name" th:text="${printer.alias}">Printer</span>
                                              <form method="post" th:action="@{/admin/remove-printer-from-dept(departmentId=${dept.id}, printerId=${printer.id})}" 
                                                    class="d-inline"
                                                    th:attr="data-printer=${printer.alias}, data-dept=${dept.name}"
                                                    onsubmit="return confirm('¬øQuitar impresora \'' + this.dataset.printer + '\' del departamento \'' + this.dataset.dept + '\'?')">
                                                  <button type="submit" class="btn-remove-item" title="Quitar impresora">
                                                      <i class="fas fa-times"></i>
                                                  </button>
                                              </form>
                                          </div>
                                      </div>
                                </td>
                                <td>
                                    <div class="action-buttons">
                                        <form method="post" th:action="@{/admin/delete-department(id=${dept.id})}" 
                                              class="d-inline" onsubmit="return confirm('¬øEliminar este departamento?')">
                                            <button type="submit" class="btn btn-sm btn-primary">üóëÔ∏è</button>
                                        </form>
                                    </div>
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
        </div>
    </div>

    <!-- Modal: Configurar Redes/VLANs -->
    <div id="configureNetworksModal" class="modal">
        <div class="modal-content modal-networks">
            <div class="modal-header modal-gradient-header">
                <h3>‚öôÔ∏è Configurar Rangos de Red / VLANs</h3>
                <button class="close-modal" onclick="closeModal('configureNetworksModal')">√ó</button>
            </div>
            <div class="modal-body">
                <!-- Formulario para agregar red -->
                <div class="network-form-box">
                    <h4 class="network-form-title">‚ûï Agregar Nueva Red</h4>
                    <form method="post" th:action="@{/admin/add-network-range}">
                        <div class="form-grid-2">
                            <div class="form-group">
                                <label class="form-label">Nombre *</label>
                                <input type="text" name="name" class="form-control" 
                                       placeholder="ej: VLAN Producci√≥n" required>
                            </div>
                            <div class="form-group">
                                <label class="form-label">Rango CIDR *</label>
                                <input type="text" name="cidrRange" class="form-control" 
                                       placeholder="192.168.1.0/24" 
                                       pattern="^([0-9]{1,3}\.){3}[0-9]{1,3}/[0-9]{1,2}$" required>
                                <small class="text-muted">Formato: 192.168.1.0/24</small>
                            </div>
                        </div>
                        <div class="form-grid-2-1">
                            <div class="form-group">
                                <label class="form-label">Descripci√≥n</label>
                                <input type="text" name="description" class="form-control" 
                                       placeholder="Red de producci√≥n - Piso 2">
                            </div>
                            <div class="form-group">
                                <label class="form-label">VLAN ID</label>
                                <input type="number" name="vlanId" class="form-control" 
                                       placeholder="10" min="1" max="4094">
                            </div>
                        </div>
                        <button type="submit" class="btn btn-primary btn-sm">‚ûï Agregar Red</button>
                    </form>
                </div>
                
                <!-- Lista de redes configuradas -->
                <h4 class="networks-title">üåê Redes Configuradas</h4>
                <div th:if="${networkRanges == null || #lists.isEmpty(networkRanges)}" class="no-networks-message">
                    üö´ No hay redes configuradas. Se usar√° la red por defecto (192.168.1.0/24)
                </div>
                <table th:unless="${networkRanges == null || #lists.isEmpty(networkRanges)}" class="data-table">
                    <thead>
                        <tr>
                            <th>Nombre</th>
                            <th>Rango CIDR</th>
                            <th>VLAN</th>
                            <th>Hosts</th>
                            <th>√öltimo Escaneo</th>
                            <th>Encontradas</th>
                            <th>Estado</th>
                            <th>Acciones</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr th:each="net : ${networkRanges}">
                            <td><strong th:text="${net.name}">Red</strong></td>
                            <td><code th:text="${net.cidrRange}">192.168.1.0/24</code></td>
                            <td>
                                <span th:if="${net.vlanId != null}" 
                                      class="badge badge-info" 
                                      th:text="'VLAN ' + ${net.vlanId}">VLAN 10</span>
                                <span th:unless="${net.vlanId != null}" style="color: #999;">--</span>
                            </td>
                            <td>
                                <span th:with="transfer=${net.toTransfer()}" 
                                      th:text="${transfer.estimatedHosts}">254</span>
                            </td>
                            <td>
                                <span th:if="${net.lastScan != null}" 
                                      th:text="${#temporals.format(net.lastScan, 'dd/MM HH:mm')}">--</span>
                                <span th:unless="${net.lastScan != null}" style="color: #999;">Nunca</span>
                            </td>
                            <td>
                                <span th:if="${net.lastFoundPrinters > 0}" 
                                      class="badge badge-success" 
                                      th:text="${net.lastFoundPrinters}">0</span>
                                <span th:unless="${net.lastFoundPrinters > 0}" style="color: #999;">--</span>
                            </td>
                            <td>
                                <span th:if="${net.active}" class="badge badge-success">‚úì Activa</span>
                                <span th:unless="${net.active}" class="badge badge-danger">‚úó Inactiva</span>
                            </td>
                            <td>
                                <div class="action-buttons">
                                    <button class="btn btn-sm btn-primary" 
                                            th:attr="data-id=${net.id}, data-name=${net.name}, data-cidr=${net.cidrRange}, data-description=${net.description}, data-vlan=${net.vlanId}, data-active=${net.active}"
                                            onclick="openEditNetworkModal(this.dataset)"
                                            title="Editar red">
                                        ‚úèÔ∏è
                                    </button>
                                    <form method="post" th:action="@{/admin/toggle-network-range(id=${net.id})}" 
                                          class="d-inline">
                                        <button type="submit" class="btn btn-sm btn-primary">
                                            <span th:text="${net.active ? 'üîí' : 'üîì'}"></span>
                                        </button>
                                    </form>
                                    <form method="post" th:action="@{/admin/delete-network-range(id=${net.id})}" 
                                          class="d-inline" 
                                          onsubmit="return confirm('¬øEliminar esta red?')">
                                        <button type="submit" class="btn btn-sm btn-danger">üóëÔ∏è</button>
                                    </form>
                                </div>
                            </td>
                        </tr>
                    </tbody>
                </table>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" onclick="closeModal('configureNetworksModal')">Cerrar</button>
            </div>
        </div>
    </div>

    <!-- Modal: Crear Departamento -->
    <div id="createDepartmentModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>‚ûï Nuevo Departamento</h3>
                <button class="close-modal" onclick="closeModal('createDepartmentModal')">√ó</button>
            </div>
            <form method="post" th:action="@{/admin/create-department}">
                <div class="modal-body">
                    <div class="form-group">
                        <label class="form-label">Nombre del Departamento *</label>
                        <input type="text" name="name" class="form-control" 
                               placeholder="ej: Ventas, Dise√±o, Contabilidad" required>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Descripci√≥n</label>
                        <textarea name="description" class="form-control" rows="2" 
                                  placeholder="Descripci√≥n breve del departamento"></textarea>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Ubicaci√≥n</label>
                        <input type="text" name="location" class="form-control" 
                               placeholder="ej: Piso 2, Edificio A">
                    </div>
                    <div class="form-group">
                        <label class="form-label">Color de Identificaci√≥n</label>
                        <input type="color" name="color" class="form-control" value="#667eea">
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" onclick="closeModal('createDepartmentModal')">Cancelar</button>
                    <button type="submit" class="btn btn-primary">Crear Departamento</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Modal: Editar Red -->
    <div id="editNetworkModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>‚úèÔ∏è Editar Rango de Red</h3>
                <button class="close-modal" onclick="closeModal('editNetworkModal')">√ó</button>
            </div>
            <form method="post" th:action="@{/admin/edit-network-range}">
                <div class="modal-body">
                    <input type="hidden" id="editNetworkId" name="id">
                    
                    <div class="form-grid-2">
                        <div class="form-group">
                            <label class="form-label">Nombre *</label>
                            <input type="text" id="editNetworkName" name="name" class="form-control" 
                                   placeholder="ej: VLAN Producci√≥n" required>
                        </div>
                        <div class="form-group">
                            <label class="form-label">Rango CIDR *</label>
                            <input type="text" id="editNetworkCidr" name="cidrRange" class="form-control" 
                                   placeholder="192.168.1.0/24" 
                                   pattern="^([0-9]{1,3}\.){3}[0-9]{1,3}/[0-9]{1,2}$" required>
                            <small class="text-muted">Formato: 192.168.1.0/24</small>
                        </div>
                    </div>
                    
                    <div class="form-grid-2-1">
                        <div class="form-group">
                            <label class="form-label">Descripci√≥n</label>
                            <input type="text" id="editNetworkDescription" name="description" class="form-control" 
                                   placeholder="Red de producci√≥n - Piso 2">
                        </div>
                        <div class="form-group">
                            <label class="form-label">VLAN ID</label>
                            <input type="number" id="editNetworkVlan" name="vlanId" class="form-control" 
                                   placeholder="10" min="1" max="4094">
                        </div>
                    </div>
                    
                    <div class="form-group">
                        <label class="modal-checkbox-label">
                            <input type="checkbox" id="editNetworkActive" name="active" value="true">
                            <span>Red Activa</span>
                        </label>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" onclick="closeModal('editNetworkModal')">Cancelar</button>
                    <button type="submit" class="btn btn-primary">Guardar Cambios</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Modal: Agregar Computadora -->
    <div id="addComputerModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>üíª Agregar Computadora</h3>
                <button class="close-modal" onclick="closeModal('addComputerModal')">√ó</button>
            </div>
            <form method="post" th:action="@{/admin/add-computer-to-dept}">
                <div class="modal-body">
                    <input type="hidden" id="addComputerDeptId" name="departmentId">
                    <div class="modal-dept-info">
                        <strong>Departamento:</strong> <span id="addComputerDeptName"></span>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Direcci√≥n MAC *</label>
                        <input type="text" name="macAddress" class="form-control" 
                               placeholder="AA:BB:CC:DD:EE:FF" 
                               pattern="([0-9A-Fa-f]{2}[:-]){5}([0-9A-Fa-f]{2})" required>
                        <small>Formato: XX:XX:XX:XX:XX:XX</small>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Nombre *</label>
                        <input type="text" name="name" class="form-control" 
                               placeholder="PC-Ventas-01" required>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Hostname</label>
                        <input type="text" name="hostname" class="form-control" 
                               placeholder="pc-ventas-01">
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" onclick="closeModal('addComputerModal')">Cancelar</button>
                    <button type="submit" class="btn btn-primary">Agregar</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Modal: Agregar Impresora -->
    <div id="addPrinterModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>üñ®Ô∏è Agregar Nueva Impresora</h3>
                <button class="close-modal" onclick="closeModal('addPrinterModal')">√ó</button>
            </div>
            <form method="post" th:action="@{/admin/add-printer}">
                <div class="modal-body">
                    <div class="form-group">
                        <label class="form-label">Alias/Nombre *</label>
                        <input type="text" name="alias" class="form-control" 
                               placeholder="ej: HP_LaserJet_Oficina" required>
                        <small>Nombre √∫nico para identificar la impresora</small>
                    </div>
                    
                    <div class="form-grid-2">
                        <div class="form-group">
                            <label class="form-label">Modelo *</label>
                            <input type="text" name="model" class="form-control" 
                                   placeholder="HP LaserJet Pro M404dn" required>
                        </div>
                        <div class="form-group">
                            <label class="form-label">Ubicaci√≥n *</label>
                            <input type="text" name="location" class="form-control" 
                                   placeholder="Oficina Principal - Piso 2" required>
                        </div>
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label">Direcci√≥n IP *</label>
                        <input type="text" name="ip" class="form-control" 
                               placeholder="192.168.1.50" 
                               pattern="^(?:[0-9]{1,3}\.){3}[0-9]{1,3}$" required>
                        <small>Direcci√≥n IP de la impresora en la red</small>
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label">URI del Dispositivo (Opcional)</label>
                        <input type="text" name="deviceUri" class="form-control" 
                               placeholder="ipp://192.168.1.50:631/ipp/print">
                        <small>URI para conectarse a la impresora (IPP, LPD, RAW, etc.)</small>
                    </div>
                    
                    <div class="form-grid-2">
                        <div class="form-group">
                            <label class="form-label">Protocolo</label>
                            <select name="protocol" class="form-control">
                                <option value="">-- Seleccionar --</option>
                                <option value="IPP">IPP (Internet Printing Protocol)</option>
                                <option value="LPD">LPD (Line Printer Daemon)</option>
                                <option value="RAW">RAW (Puerto 9100)</option>
                                <option value="SMB">SMB (Samba/Windows)</option>
                                <option value="USB">USB</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label class="form-label">Puerto</label>
                            <input type="number" name="port" class="form-control" 
                                   placeholder="631" min="1" max="65535">
                        </div>
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label">Driver PPD (Opcional)</label>
                        <input type="text" name="driver" class="form-control" 
                               placeholder="ruta/al/driver.ppd">
                    </div>
                    
                    <div class="modal-auto-config">
                        <h4>‚ÑπÔ∏è Configuraci√≥n Autom√°tica</h4>
                        <div class="modal-checkbox-group">
                            <label class="modal-checkbox-label">
                                <input type="checkbox" name="addToCups" value="true" checked>
                                <span>Agregar a CUPS autom√°ticamente</span>
                            </label>
                            <label class="modal-checkbox-label">
                                <input type="checkbox" name="shareViaSamba" value="true" checked>
                                <span>Compartir v√≠a Samba</span>
                            </label>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" onclick="closeModal('addPrinterModal')">Cancelar</button>
                    <button type="submit" class="btn btn-primary">Agregar Impresora</button>
                </div>
            </form>
        </div>
    </div>
    
    <!-- Modal: Editar Impresora -->
    <div id="editPrinterModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>‚úèÔ∏è Editar Impresora</h3>
                <button class="close-modal" onclick="closeModal('editPrinterModal')">√ó</button>
            </div>
            <form method="post" th:action="@{/admin/edit-printer}">
                <div class="modal-body">
                    <input type="hidden" id="editPrinterId" name="id">
                    
                    <div class="form-group">
                        <label class="form-label">Alias/Nombre *</label>
                        <input type="text" id="editPrinterAlias" name="alias" class="form-control" required>
                    </div>
                    
                    <div class="form-grid-2">
                        <div class="form-group">
                            <label class="form-label">Modelo *</label>
                            <input type="text" id="editPrinterModel" name="model" class="form-control" required>
                        </div>
                        <div class="form-group">
                            <label class="form-label">Ubicaci√≥n *</label>
                            <input type="text" id="editPrinterLocation" name="location" class="form-control" required>
                        </div>
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label">Direcci√≥n IP *</label>
                        <input type="text" id="editPrinterIp" name="ip" class="form-control" 
                               pattern="^(?:[0-9]{1,3}\.){3}[0-9]{1,3}$" required>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" onclick="closeModal('editPrinterModal')">Cancelar</button>
                    <button type="submit" class="btn btn-primary">Guardar Cambios</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Modal: Asignar Impresora -->
    <div id="assignPrinterModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>üñ®Ô∏è Asignar Impresora</h3>
                <button class="close-modal" onclick="closeModal('assignPrinterModal')">√ó</button>
            </div>
            <form method="post" th:action="@{/admin/assign-printer-to-dept}">
                <div class="modal-body">
                    <input type="hidden" id="assignPrinterDeptId" name="departmentId">
                    <div class="modal-dept-info">
                        <strong>Departamento:</strong> <span id="assignPrinterDeptName"></span>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Seleccionar Impresora *</label>
                        <select name="printerId" class="form-control" required>
                            <option value="">-- Seleccione una impresora --</option>
                            <option th:each="p : ${allPrinters}" th:value="${p.id}" 
                                    th:text="${p.alias + ' (' + p.ip + ') - ' + p.model}">
                                Impresora
                            </option>
                        </select>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" onclick="closeModal('assignPrinterModal')">Cancelar</button>
                    <button type="submit" class="btn btn-primary">Asignar</button>
                </div>
            </form>
        </div>
    </div>

    <footer th:replace="fragments/footer.html :: footer"></footer>

    <script th:src="@{/js/admin.js}"></script>
    
    <!-- Modal de Progreso de Escaneo -->
    <div id="scanProgressModal" class="modal" style="display: none;">
        <div class="modal-content scan-modal-content">
            <div class="modal-header scan-modal-header">
                <h3>üîç Escaneando Red en Busca de Impresoras...</h3>
            </div>
            <div class="modal-body">
                <div class="scan-progress-wrapper">
                    <div class="scan-progress-info">
                        <span id="scanProgress">0%</span>
                        <span id="scanDetails">Preparando escaneo...</span>
                    </div>
                    <div class="scan-progress-bar-bg">
                        <div id="progressBar" class="scan-progress-bar"></div>
                    </div>
                </div>
                
                <div class="scan-stats-container">
                    <div class="scan-stats-grid-2">
                        <div>
                            <div class="scan-stat-item">Red Actual:</div>
                            <div id="currentNetwork" class="scan-stat-network">--</div>
                        </div>
                        <div>
                            <div class="scan-stat-item">Impresoras Encontradas:</div>
                            <div id="foundPrinters" class="scan-stat-printers">0</div>
                        </div>
                        <div>
                            <div class="scan-stat-item">Hosts Escaneados:</div>
                            <div id="hostsScanned" class="scan-stat-value">0 / 0</div>
                        </div>
                        <div>
                            <div class="scan-stat-item">Tiempo Restante:</div>
                            <div id="timeRemaining" class="scan-stat-value">Calculando...</div>
                        </div>
                    </div>
                </div>
                
                <div class="scan-message-wrapper">
                    <div id="scanMessage">‚è≥ Por favor espera, esto puede tomar varios minutos...</div>
                    <button id="forceCompleteBtn" class="btn btn-sm btn-warning scan-force-btn"
                            onclick="forceComplete()">
                        ‚ö†Ô∏è Forzar Completar (si se qued√≥ atascado)
                    </button>
                </div>
            </div>
        </div>
    </div>
    
    <script>
        function openEditNetworkModal(data) {
            document.getElementById('editNetworkId').value = data.id;
            document.getElementById('editNetworkName').value = data.name;
            document.getElementById('editNetworkCidr').value = data.cidr;
            document.getElementById('editNetworkDescription').value = data.description || '';
            document.getElementById('editNetworkVlan').value = data.vlan || '';
            document.getElementById('editNetworkActive').checked = data.active === 'true';
            openModal('editNetworkModal');
        }
        
        function openEditPrinterModal(data) {
            document.getElementById('editPrinterId').value = data.id;
            document.getElementById('editPrinterAlias').value = data.alias;
            document.getElementById('editPrinterModel').value = data.model;
            document.getElementById('editPrinterLocation').value = data.location;
            document.getElementById('editPrinterIp').value = data.ip;
            openModal('editPrinterModal');
        }
        
        function openAddComputerModal(data) {
            document.getElementById('addComputerDeptId').value = data.deptId;
            document.getElementById('addComputerDeptName').textContent = data.deptName;
            openModal('addComputerModal');
        }

        function openAssignPrinterModal(data) {
            document.getElementById('assignPrinterDeptId').value = data.deptId;
            document.getElementById('assignPrinterDeptName').textContent = data.deptName;
            openModal('assignPrinterModal');
        }

        // Auto-cerrar alertas
        document.addEventListener('DOMContentLoaded', function() {
            const alerts = document.querySelectorAll('.alert');
            alerts.forEach(alert => {
                setTimeout(() => {
                    alert.style.opacity = '0';
                    setTimeout(() => alert.remove(), 300);
                }, 5000);
            });
            
            // Verificar si hay escaneo en progreso
            const urlParams = new URLSearchParams(window.location.search);
            if (urlParams.get('scanning') === 'true') {
                startScanMonitoring();
            }
        });
        
        let scanInterval = null;
        let lastProgress = 0;
        let stuckCount = 0;
        
        function forceComplete() {
            clearInterval(scanInterval);
            document.getElementById('progressBar').style.width = '100%';
            document.getElementById('scanProgress').textContent = '100%';
            document.getElementById('scanMessage').innerHTML = 
                '‚úÖ <strong>Escaneo Finalizado</strong><br>Recargando p√°gina...';
            setTimeout(() => {
                window.location.href = '/admin/';
            }, 2000);
        }
        
        function startScanMonitoring() {
            // Mostrar modal de progreso
            document.getElementById('scanProgressModal').style.display = 'block';
            
            // Actualizar cada segundo
            scanInterval = setInterval(updateScanProgress, 1000);
            
            // Primera actualizaci√≥n inmediata
            updateScanProgress();
        }
        
        function updateScanProgress() {
            fetch('/admin/scan-status')
                .then(response => response.json())
                .then(data => {
                    if (!data.scanning && data.progress === 0) {
                        // No hay escaneo activo
                        return;
                    }
                    
                    // Actualizar barra de progreso
                    document.getElementById('progressBar').style.width = data.progress + '%';
                    document.getElementById('scanProgress').textContent = data.progress + '%';
                    
                    // Actualizar detalles
                    document.getElementById('currentNetwork').textContent = data.currentNetwork || 'Iniciando...';
                    document.getElementById('foundPrinters').textContent = data.foundPrinters;
                    document.getElementById('hostsScanned').textContent = 
                        data.scannedHosts + ' / ' + data.totalHosts;
                    
                    // Tiempo restante
                    if (data.estimatedRemaining > 0) {
                        const minutes = Math.floor(data.estimatedRemaining / 60);
                        const seconds = data.estimatedRemaining % 60;
                        document.getElementById('timeRemaining').textContent = 
                            minutes + 'm ' + seconds + 's';
                    } else {
                        document.getElementById('timeRemaining').textContent = 'Calculando...';
                    }
                    
                    // Detectar si se qued√≥ atascado
                    if (data.progress === lastProgress && data.progress > 95 && data.progress < 100) {
                        stuckCount++;
                        if (stuckCount > 10) { // 10 segundos atascado
                            document.getElementById('forceCompleteBtn').style.display = 'inline-block';
                        }
                    } else {
                        stuckCount = 0;
                        lastProgress = data.progress;
                        document.getElementById('forceCompleteBtn').style.display = 'none';
                    }
                    
                    // Actualizar mensaje
                    if (data.scanning) {
                        document.getElementById('scanDetails').textContent = 
                            'Escaneando ' + data.currentNetwork + '...';
                    } else if (data.progress >= 100 || (!data.scanning && data.progress > 0)) {
                        // Escaneo completado
                        document.getElementById('scanMessage').innerHTML = 
                            '‚úÖ <strong>Escaneo Completado!</strong><br>' +
                            'Encontradas ' + data.foundPrinters + ' impresoras.<br>' +
                            'Recargando p√°gina...';
                        
                        clearInterval(scanInterval);
                        
                        // Recargar p√°gina despu√©s de 3 segundos
                        setTimeout(() => {
                            window.location.href = '/admin/';
                        }, 3000);
                    }
                })
                .catch(error => {
                    console.error('Error al obtener estado del escaneo:', error);
                });
        }
    </script>
</body>
</html>
