<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <th:block th:replace="fragments/head :: header"/>
    <title>Compartir Impresoras</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css"/>
    <link rel="stylesheet" th:href="@{/css/admin-sidebar.css}"/>
    <link rel="stylesheet" th:href="@{/css/admin-modern.css}"/>
    <link rel="stylesheet" th:href="@{/css/admin-departments.css}"/>
    <link rel="stylesheet" th:href="@{/css/admin-sidebar-override.css}"/>
    <link rel="stylesheet" th:href="@{/css/home.css}"/>
    <link rel="stylesheet" th:href="@{/css/notifications.css}"/>
</head>
<body>
    <nav th:replace="fragments/nav.html :: nav"></nav>
    <div th:if="${success}" class="alert alert-success alert-fixed">
        <span th:text="${success}"></span>
    </div>
    <div th:if="${error}" class="alert alert-error alert-fixed">
        <span th:text="${error}"></span>
    </div>

    <div class="admin-layout">
        <!-- Sidebar -->
        <aside th:replace="fragments/admin-sidebar.html :: sidebar"></aside>
        
        <!-- Contenido Principal -->
        <div class="admin-content">
            <div class="departments-container">
                <!-- Header -->
                <div class="departments-header">
                    <h1><i class="fas fa-share-alt"></i> Compartir Impresoras</h1>
                    <p>Comparte impresoras locales y configura clientes IPP</p>
                </div>
                
                <!-- Sección de Compartir Impresoras -->
                <div class="section-card full-width" style="background: white; border-radius: 12px; box-shadow: 0 2px 8px rgba(0,0,0,0.1); border: 1px solid #e2e8f0;">
                    <div class="section-body" style="padding: 2rem;">
                        <div class="sharing-tools">
                            <div class="tool-section">
                                <h3><i class="fas fa-desktop"></i> Compartir Impresora USB/Local</h3>
                                <p>Comparte una impresora conectada localmente a tu computadora con la red</p>
                                
                                <div class="os-tabs">
                                    <button class="os-tab active" data-os="windows"><i class="fab fa-windows"></i> Windows</button>
                                    <button class="os-tab" data-os="linux"><i class="fab fa-linux"></i> Linux</button>
                                </div>
                                
                                <div class="os-content active" id="windows-share">
                                    <div class="instructions">
                                        <h4> Configuración Completa - Cliente USB en Segundo Plano:</h4>
                                        
                            
                                       <h4>Paso 1: Instalación de Requerimientos</h4>
                                        <p ><strong>Requerimientos:</strong></p>
                                        <ol start="1" style="margin-bottom: 1.5rem;">
                                            <li>Java (si no está instalado) - Requerido para el cliente</li>
                                            <li>SumatraPDF - Para impresión silenciosa</li>
                                            <li>Cliente USB - Se descarga desde el servidor</li>
                                            <li>Configuración de inicio automático - Se ejecutará al encender la PC</li>
                                        </ol>
                                        <h4>Paso 2: Descargar el Script</h4>
                                        <ol style="margin-bottom: 1.5rem;">
                                            <li>Descarga el script haciendo clic en el botón de abajo</li>
                                        </ol>
                                        
                                        <a href="/api/download/share-windows-script" class="btn btn-download" onclick="return downloadShareScript();" style="margin-bottom: 2rem;"><i class="fas fa-download"></i> Descargar Script de Compartir (.BAT)</a>
                                        
                                        <h4>Paso 3: Ejecutar el Script</h4>
                                        <ol start="2" style="margin-bottom: 1.5rem;">
                                            <li>Haz <strong>DOBLE CLIC</strong> en el archivo descargado (<code>compartir-impresora-windows.bat</code>)</li>
                                            <li>Se solicitarán permisos de administrador automáticamente - <strong>acepta</strong></li>
                                            <li>El script buscará automáticamente tus impresoras USB</li>
                                            <li><strong>Selecciona la impresora USB</strong> que deseas compartir del menú</li>
                                        </ol>

                                        

                                        <details style="margin-top: 1rem; border: 1px solid #e2e8f0; border-radius: 6px; padding: 1rem;">
                                            <summary style="cursor: pointer; font-weight: 600; "><i class="fas fa-cog"></i> Instalación Manual de Requisitos (Opcional)</summary>
                                            <div >
                                                <p>Si prefieres instalar los requisitos manualmente antes de ejecutar el script:</p>
                                                
                                                <h5 >🔹 1. Instalar Java (Obligatorio)</h5>
                                                <p><strong>Opción A:</strong> Con Winget (recomendado - rápido)</p>
                                                <code class="command-block" style="display: block; background: #1e293b; color: #e2e8f0; padding: 0.75rem; border-radius: 4px; font-family: monospace; margin: 0.5rem 0;">winget install EclipseAdoptium.Temurin.17.JRE</code>
                                                
                                                <p ><strong>Opción B:</strong> Descarga manual</p>
                                                <ul>
                                                    <li><a href="https://www.java.com/es/download/" target="_blank" style="color: #3b82f6;">Java oficial</a></li>
                                                    <li><a href="https://aka.ms/download-jdk/microsoft-jdk-17-windows-x64.msi" target="_blank" style="color: #3b82f6;">Microsoft JDK 17</a></li>
                                                </ul>

                                                <h5 >🔹 2. Instalar SumatraPDF (Recomendado)</h5>
                                                <p>Para impresión completamente silenciosa sin diálogos:</p>
                                                
                                                <p><strong>Opción A:</strong> Con Winget</p>
                                                <code class="command-block" style="display: block; background: #1e293b; color: #e2e8f0; padding: 0.75rem; border-radius: 4px; font-family: monospace; margin: 0.5rem 0;">winget install SumatraPDF.SumatraPDF</code>
                                                
                                                <p ><strong>Opción B:</strong> Descarga manual</p>
                                                <ul>
                                                    <li><a href="https://www.sumatrapdfreader.org/download-free-pdf-viewer" target="_blank" style="color: #3b82f6;">SumatraPDF oficial</a></li>
                                                </ul>
                                                
                                                <div style="background: #fef3c7; border-left: 3px solid #f59e0b; padding: 0.75rem; border-radius: 4px; margin-top: 1rem;">
                                                    <strong>💡 Nota:</strong> Sin SumatraPDF, el sistema usará Adobe Reader o PowerShell, que pueden ser más lentos.
                                                </div>
                                            </div>
                                        </details>

                                        <details style="margin-top: 1rem; border: 1px solid #e2e8f0; border-radius: 6px; padding: 1rem;">
                                            <summary style="cursor: pointer; font-weight: 600; "><i class="fas fa-tools"></i> Control Manual del Cliente</summary>
                                            <div style="margin-top: 1rem; padding-left: 1rem;">
                                                <p>Después de la instalación, el cliente se guarda en:</p>
                                                <code style="background: #f1f5f9; padding: 0.25rem 0.5rem; border-radius: 3px;">%APPDATA%\PrinterShare\</code>
                                                <p style="margin-top: 1rem;">Ruta completa típica:</p>
                                                <code style="background: #f1f5f9; padding: 0.25rem 0.5rem; border-radius: 3px;">C:\Users\TuUsuario\AppData\Roaming\PrinterShare\</code>
                                                
                                                <h4 >Iniciar en Segundo Plano</h4>
                                                <ol>
                                                    <li>Abre la carpeta <code>%APPDATA%\PrinterShare</code></li>
                                                    <li>Haz doble clic en: <code>start-client-hidden.vbs</code></li>
                                                    <li>El cliente se iniciará sin mostrar ventanas</li>
                                                </ol>

                                                <h4 > Ver Logs en Tiempo Real</h4>
                                                <ol>
                                                    <li>Abre la carpeta <code>%APPDATA%\PrinterShare</code></li>
                                                    <li>Haz doble clic en: <code>ver-logs.bat</code></li>
                                                    <li>Verás los logs en vivo en una ventana</li>
                                                </ol>

                                                <h4 > Detener el Cliente</h4>
                                                <ol>
                                                    <li>Abre la carpeta <code>%APPDATA%\PrinterShare</code></li>
                                                    <li>Haz doble clic en: <code>stop-client.bat</code></li>
                                                </ol>

                                                <h4 >Iniciar con Ventana (Debug)</h4>
                                                <ol>
                                                    <li>Abre la carpeta <code>%APPDATA%\PrinterShare</code></li>
                                                    <li>Haz doble clic en: <code>start-client.bat</code></li>
                                                    <li>Verás una ventana con logs en tiempo real</li>
                                                </ol>
                                            </div>
                                        </details>

                                        <div style="margin-top: 1.5rem; padding: 0.75rem; background: #fff3cd; border-left: 3px solid #ffc107; border-radius: 4px; font-size: 0.875rem;">
                                            <strong>⚠️ Importante:</strong> La computadora con la impresora USB debe estar <strong>encendida</strong> para que otros puedan imprimir.
                                        </div>
                                    </div>
                                </div>
                                
                                <div class="os-content" id="linux-share">
                                    <div class="instructions">
                                        <h4>Instrucciones para Linux:</h4>
                                        <ol>
                                            <li>Descarga el script bash haciendo clic en el botón de abajo</li>
                                            <li>Dale permisos de ejecución: <code>chmod +x compartir-impresora-linux.sh</code></li>
                                            <li>Ejecuta con sudo: <code>sudo ./compartir-impresora-linux.sh</code></li>
                                            <li>Selecciona la impresora USB/Local que deseas compartir del menú</li>
                                            <li>El script configurará y registra en el servidor</li>
                                            <li>¡Listo! Ya puedes ver la impresora en la red</li>
                                        </ol>
                                  
                                        <p style="margin-top: 1rem; padding: 0.75rem; background: #fff3cd; border-left: 3px solid #ffc107; border-radius: 4px; font-size: 0.875rem;">
                                            <strong>⚠️ Importante:</strong> La computadora con la impresora USB debe estar <strong>encendida</strong> y CUPS debe estar ejecutándose.
                                        </p>
                                    </div>
                                    <a href="/api/download/share-linux-script" class="btn btn-download" onclick="return downloadShareLinuxScript();"><i class="fas fa-download"></i> Descargar Script Linux (.SH)</a>
                                </div>
                            </div>
                            
                            <div class="tool-section">
                                <h3><i class="fas fa-network-wired"></i> Configurar Impresora IPP en Cliente</h3>
                                <p>Configura una computadora cliente para usar las impresoras compartidas</p>
                                
                                <div class="ipp-config">
                                    <label>Selecciona la impresora:</label>
                                    <select id="printerSelect" class="form-control">
                                        <option value="">-- Selecciona una impresora --</option>
                                    </select>
                                    
                                    <div id="ippInstructions" style="display:none; margin-top: 1rem;">
                                        <div class="info-box">
                                            <strong>URL IPP:</strong>
                                            <code id="ippUrl" class="selectable"></code>
                                            <button class="btn-copy" onclick="copyToClipboard('ippUrl', event)"><i class="fas fa-copy"></i> Copiar</button>
                                        </div>
                                        
                                        <div class="client-tabs">
                                            <button class="client-tab active" data-client="windows-client"><i class="fab fa-windows"></i> Windows</button>
                                            <button class="client-tab" data-client="linux-client"><i class="fab fa-linux"></i> Linux</button>
                                            <button class="client-tab" data-client="macos-client"><i class="fab fa-apple"></i> macOS</button>
                                        </div>
                                        
                                        <div class="client-content active" id="windows-client">
                                            <h4>Windows:</h4>
                                            
                                            <div>
                                                <h4>Método Recomendado: Script Automático (.BAT)</h4>
                                                <p >La forma más fácil y rápida de instalar la impresora:</p>
                                                <ol>
                                                    <li>Descarga el script BAT haciendo clic en el botón de abajo</li>
                                                    <li>Haz <strong>DOBLE CLIC </strong> en el archivo <code>.bat</code> descargado</li>
                                                    <li>Se solicitarán permisos de administrador automáticamente</li>
                                                    <li>La impresora se instalará automáticamente en 10-15 segundos</li>
                                                    <li>¡Listo! Ya puedes imprimir</li>
                                                </ol>
                                            </div>
                                            
                                            <button class="btn btn-download" onclick="downloadWindowsClientScript()" >
                                                <i class="fas fa-download"></i> Descargar Script Automático (.BAT)
                                            </button>
                                        
                                            
                                    
                                            
                                            <details style="margin-top: 1.5rem;">
                                                <summary >📋 Instalación Manual (si prefieres hacerlo sin el script)</summary>
                                                <ol>
                                                    <li>Abre "Configuración" → "Dispositivos" → "Impresoras y escáneres"</li>
                                                    <li>Haz clic en "Agregar impresora o escáner"</li>
                                                    <li>Selecciona "La impresora que deseo no está en la lista"</li>
                                                    <li>Selecciona "Seleccionar una impresora compartida por nombre"</li>
                                                    <li>Ingresa la URL IPP mostrada arriba</li>
                                                    <li>Instala los controladores cuando se solicite</li>
                                                </ol>
                                            </details>
                                        </div>
                                        
                                        <div class="client-content" id="linux-client">
                                            <h4>Linux:</h4>
                                            
                                            <div>
                                                <h4>Método Recomendado: Script Automático (.SH)</h4>
                                                <p>La forma más fácil y rápida de instalar la impresora:</p>
                                                <ol>
                                                    <li>Descarga el script Bash haciendo clic en el botón de abajo</li>
                                                    <li>Dale permisos de ejecución: <code>chmod +x instalar-impresora-ipp.sh</code></li>
                                                    <li>Ejecuta el script: <code>./instalar-impresora-ipp.sh</code></li>
                                                    <li>Selecciona la impresora del menú interactivo</li>
                                                    <li>La impresora se instalará automáticamente con IPP Everywhere</li>
                                                    <li>¡Listo! Ya puedes imprimir con PDF directo</li>
                                                </ol>
                                            </div>
                                            
                                            <button class="btn btn-download" onclick="downloadLinuxClientScript()" style="margin-bottom: 1.5rem;">
                                                <i class="fas fa-download"></i> Descargar Script Automático (.SH)
                                            </button>
                                            
                                            <details style="margin-top: 1.5rem;">
                                                <summary>📋 Instalación Manual (si prefieres hacerlo sin el script)</summary>
                                                <ol>
                                                    <li>Abre "Configuración del sistema" → "Impresoras"</li>
                                                    <li>Haz clic en "Agregar" o "+"</li>
                                                    <li>Selecciona "Impresora de red" → "Impresora IPP"</li>
                                                    <li>Ingresa la URL IPP mostrada arriba</li>
                                                </ol>
                                                <p><strong>O usa este comando:</strong></p>
                                                <code class="command-block selectable" id="linuxCommand"></code>
                                                <button class="btn-copy" onclick="copyToClipboard('linuxCommand', event)"><i class="fas fa-copy"></i> Copiar</button>
                                            </details>
                                        </div>
                                        
                                        <div class="client-content" id="macos-client">
                                            <h4>macOS:</h4>
                                            
                                            
                                            <div>
                                                <h4>Método 1: Instalación Automática (Recomendado)</h4>
                                                <ol>
                                                    <li>Abre "Preferencias del Sistema" → "Impresoras y Escáneres"</li>
                                                    <li>Haz clic en el botón <strong>"+"</strong> para agregar una impresora</li>
                                                    <li>Espera a que macOS detecte automáticamente la impresora IPP</li>
                                                    <li>Si aparece en la lista, selecciónala y haz clic en "Agregar"</li>
                                                    <li>macOS seleccionará automáticamente el driver <strong>AirPrint</strong> (PDF directo)</li>
                                                </ol>
                                                
                                                <p style="margin-top: 1rem; padding: 0.75rem; background: #d1fae5; border-left: 3px solid #10b981; border-radius: 4px; font-size: 0.875rem;">
                                                    <strong>✅ Ventaja:</strong> AirPrint envía PDF directamente con formato completo (colores, negritas, imágenes)
                                                </p>
                                            </div>
                                            
                                            <details style="margin-top: 1.5rem;">
                                                <summary>📋 Método 2: Instalación Manual Avanzada</summary>
                                                <div style="margin-top: 1rem;">
                                                    <p>Si la impresora no aparece automáticamente:</p>
                                                    <ol>
                                                        <li>Abre "Preferencias del Sistema" → "Impresoras y Escáneres"</li>
                                                        <li>Haz clic en el botón <strong>"+"</strong></li>
                                                        <li><strong>Mantén presionada la tecla "Option" (⌥)</strong> y haz clic en "Avanzado"</li>
                                                        <li>En "Tipo", selecciona <strong>"Internet Printing Protocol - IPP"</strong></li>
                                                        <li>En "URL", pega la URL IPP mostrada arriba</li>
                                                        <li>En "Nombre", ponle un nombre descriptivo a la impresora</li>
                                                        <li>En "Usar", selecciona una de estas opciones:
                                                            <ul style="margin-left: 2rem; margin-top: 0.5rem;">
                                                                <li><strong>Opción 1 (Recomendada):</strong> "Generic PostScript Printer" - Para documentos con formato</li>
                                                                <li><strong>Opción 2:</strong> "Generic PCL Printer" - Compatible con la mayoría de impresoras</li>
                                                                <li><strong>Opción 3:</strong> Buscar el modelo específico si aparece en la lista</li>
                                                                <li><strong>Opción 4:</strong> "AirPrint" - Si está disponible (mejor calidad)</li>
                                                            </ul>
                                                        </li>
                                                        <li>Haz clic en "Agregar"</li>
                                                    </ol>
                                                    
                                                    <div style="margin-top: 1rem; padding: 0.75rem; background: #fef3c7; border-left: 3px solid #f59e0b; border-radius: 4px; font-size: 0.875rem;">
                                                        <strong>⚠️ Importante:</strong>
                                                        <ul style="margin-left: 1.5rem; margin-top: 0.5rem;">
                                                            <li>NO uses "Generic Text Only" - perderás el formato</li>
                                                            <li>Si la impresora es <strong>Epson</strong>, busca drivers Epson en la lista</li>
                                                            <li>Si es <strong>HP</strong>, busca drivers HP en la lista</li>
                                                            <li>Si es <strong>Brother</strong>, busca drivers Brother en la lista</li>
                                                            <li>Si no encuentras el modelo, usa "Generic PostScript Printer"</li>
                                                        </ul>
                                                    </div>
                                                </div>
                                            </details>
                                            
                                            <details style="margin-top: 1rem;">
                                                <summary>💻 Método 3: Línea de Comandos (Terminal)</summary>
                                                <div style="margin-top: 1rem;">
                                                    <p>Para usuarios avanzados:</p>
                                                    <code class="command-block" style="display: block; background: #1e293b; color: #e2e8f0; padding: 1rem; border-radius: 4px; font-family: monospace; font-size: 0.875rem; overflow-x: auto; margin: 1rem 0;">
# Reemplaza los valores entre &lt; &gt;<br>
lpadmin -p "&lt;NOMBRE_IMPRESORA&gt;" \<br>
&nbsp;&nbsp;-v "<span id="macIppUrl"></span>" \<br>
&nbsp;&nbsp;-P "/System/Library/Frameworks/ApplicationServices.framework/Versions/A/Frameworks/PrintCore.framework/Resources/Generic.ppd" \<br>
&nbsp;&nbsp;-E
                                                    </code>
                                                    <p style="font-size: 0.875rem; color: #64748b;"><strong>Ejemplo:</strong></p>
                                                    <code class="command-block" style="display: block; background: #1e293b; color: #e2e8f0; padding: 1rem; border-radius: 4px; font-family: monospace; font-size: 0.875rem; overflow-x: auto;">
lpadmin -p "EPSON-Oficina" \<br>
&nbsp;&nbsp;-v "ipp://10.1.1.47:8633/printers/EPSON-THnomina" \<br>
&nbsp;&nbsp;-P "/System/Library/Frameworks/ApplicationServices.framework/Versions/A/Frameworks/PrintCore.framework/Resources/Generic.ppd" \<br>
&nbsp;&nbsp;-E
                                                    </code>
                                                </div>
                                            </details>
                                            
                                          
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Barra de progreso minimizada GLOBAL -->
    <div th:replace="fragments/scan-progress-minimized.html :: minimized-bar"></div>

    <script th:src="@{/js/admin.js}"></script>
    <script th:src="@{/js/scan-monitor-global.js}"></script>
    <script th:src="@{/js/notifications.js}"></script>
    <script th:src="@{/js/home-printer-sharing.js}"></script>
    <script>
        // Cargar impresoras desde la API al cargar la página
        document.addEventListener('DOMContentLoaded', function() {
            loadPrinters();
        });
        
        async function loadPrinters() {
            try {
                const response = await fetch('/api/printers');
                const data = await response.json();
                
                const serverIp = data.serverIp;
                const printers = data.printers;
                
                const select = document.getElementById('printerSelect');
                select.innerHTML = '<option value="">-- Selecciona una impresora --</option>';
                
                printers.forEach(printer => {
                    const option = document.createElement('option');
                    option.value = printer.id;
                    option.textContent = printer.alias;
                    option.dataset.ippuri = printer.ippUri;
                    option.dataset.name = printer.alias;
                    option.dataset.location = printer.location || ''; // Agregar ubicación para detectar USB
                    select.appendChild(option);
                });
                
               
            } catch (error) {
                console.error('❌ Error cargando impresoras:', error);
            }
        }
        
        function downloadShareScript() {
            // Iniciar descarga
            window.location.href = '/api/download/share-windows-script';
            
            // Mostrar instrucciones mejoradas
            setTimeout(() => {
                showSuccess('Script descargado correctamente', 'Descarga Completa');
                setTimeout(() => {
                    showInfo(
                        '<strong>✅ Instrucciones Simples:</strong><br><br>' +
                        '<strong>1. Haz DOBLE CLIC</strong> en el archivo descargado: <code>compartir-impresora-windows.bat</code><br>' +
                        '<strong>2. Se solicitarán permisos</strong> de administrador automáticamente - acepta<br>' +
                        '<strong>3. Selecciona la impresora USB</strong> que deseas compartir del menú<br>' +
                        '<strong>4. El script</strong> la configurará y registrará automáticamente<br>' +
                        '<strong>5. ¡Listo!</strong> La impresora estará disponible en la red<br><br>' +
                        '<strong>💡 Qué hace el script:</strong><br>' +
                        '✅ Detecta todas tus impresoras USB/Locales<br>' +
                        '✅ Comparte la impresora en la red (SMB)<br>' +
                        '✅ La registra en el servidor central<br>' +
                        '✅ Configura el firewall automáticamente<br>' +
                        '✅ Asigna un puerto IPP único<br><br>' +
                        '<strong>⚠️ Importante:</strong> La PC con la impresora debe estar encendida para que otros puedan imprimir',
                        'Cómo usar el script'
                    );
                }, 800);
            }, 500);
            
            return false; // Prevenir navegación adicional
        }
        
        function downloadShareLinuxScript() {
            // Iniciar descarga
            window.location.href = '/api/download/share-linux-script';
            
            // Mostrar instrucciones mejoradas
            setTimeout(() => {
                showSuccess('Script descargado correctamente', 'Descarga Completa');
                setTimeout(() => {
                    showInfo(
                        '<strong>✅ Instrucciones Simples:</strong><br><br>' +
                        '<strong>1. Abre una terminal</strong> en la carpeta donde descargaste el script<br>' +
                        '<strong>2. Dale permisos:</strong> <code>chmod +x compartir-impresora-linux.sh</code><br>' +
                        '<strong>3. Ejecuta el script:</strong> <code>sudo ./compartir-impresora-linux.sh</code><br>' +
                        '<strong>4. Selecciona la impresora USB</strong> que deseas compartir del menú<br>' +
                        '<strong>5. ¡Listo!</strong> La impresora estará disponible en la red<br><br>' +
                        '<strong>💡 Qué hace el script:</strong><br>' +
                        '✅ Detecta todas tus impresoras CUPS locales<br>' +
                        '✅ Comparte la impresora vía IPP/CUPS<br>' +
                        '✅ La registra en el servidor central<br>' +
                        '✅ Configura el firewall automáticamente<br>' +
                        '✅ Asigna un puerto IPP único<br><br>' +
                        '<strong>⚠️ Importante:</strong> CUPS debe estar instalado y la PC debe estar encendida',
                        'Cómo usar el script'
                    );
                }, 800);
            }, 500);
            
            return false; // Prevenir navegación adicional
        }
    </script>
</body>
</html>
