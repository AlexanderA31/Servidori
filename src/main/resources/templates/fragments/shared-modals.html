<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<body>
    <!-- MODALES COMPARTIDOS - Usados en múltiples vistas -->
    
    <!-- Modal: Agregar Computadora a Departamento -->
    <div th:fragment="addComputerToDeptModal">
        <div id="addComputerModal" class="modal">
            <div class="modal-content">
                <div class="modal-header">
                    <h3><i class="fas fa-desktop"></i> Agregar Computadora</h3>
                    <button class="close-modal" onclick="closeModal('addComputerModal')">×</button>
                </div>
                <form method="post" th:action="@{/admin/add-computer-to-dept}">
                    <div class="modal-body">
                        <input type="hidden" id="addComputerDeptId" name="departmentId">
                        <div class="modal-dept-info">
                            <strong>Departamento:</strong> <span id="addComputerDeptName"></span>
                        </div>
                        <div class="form-group">
                            <label class="form-label">Dirección MAC *</label>
                            <input type="text" name="macAddress" class="form-control" 
                                   placeholder="AA:BB:CC:DD:EE:FF" 
                                   pattern="([0-9A-Fa-f]{2}[:-]){5}([0-9A-Fa-f]{2})" required>
                            <small>Formato: XX:XX:XX:XX:XX:XX</small>
                        </div>
                        <div class="form-group">
                            <label class="form-label">Nombre *</label>
                            <input type="text" name="name" class="form-control" 
                                   placeholder="PC-Ventas-01" required>
                        </div>
                        <div class="form-group">
                            <label class="form-label">Hostname</label>
                            <input type="text" name="hostname" class="form-control" 
                                   placeholder="pc-ventas-01">
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" onclick="closeModal('addComputerModal')">Cancelar</button>
                        <button type="submit" class="btn btn-primary">Agregar</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- Modal: Asignar Impresora a Departamento -->
    <div th:fragment="assignPrinterModal">
        <div id="assignPrinterModal" class="modal">
            <div class="modal-content">
                <div class="modal-header">
                    <h3><i class="fas fa-print"></i> Asignar Impresora</h3>
                    <button class="close-modal" onclick="closeModal('assignPrinterModal')">×</button>
                </div>
                <form method="post" th:action="@{/admin/assign-printer-to-dept}">
                    <div class="modal-body">
                        <input type="hidden" id="assignPrinterDeptId" name="departmentId">
                        <div class="modal-dept-info">
                            <strong>Departamento:</strong> <span id="assignPrinterDeptName"></span>
                        </div>
                        <div class="form-group">
                            <label class="form-label">Seleccionar Impresora *</label>
                            <select name="printerId" class="form-control" required>
                                <option value="">-- Seleccione una impresora --</option>
                                <option th:each="p : ${allPrinters}" th:value="${p.id}" 
                                        th:text="${p.alias + ' (' + p.ip + ') - ' + p.model}">
                                    Impresora
                                </option>
                            </select>
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" onclick="closeModal('assignPrinterModal')">Cancelar</button>
                        <button type="submit" class="btn btn-primary">Asignar</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- Modal: Crear Departamento -->
    <div th:fragment="createDepartmentModal">
        <div id="createDepartmentModal" class="modal">
            <div class="modal-content">
                <div class="modal-header">
                    <h3><i class="fas fa-building"></i> Nuevo Departamento</h3>
                    <button class="close-modal" onclick="closeModal('createDepartmentModal')">×</button>
                </div>
                <form method="post" th:action="@{/admin/create-department}">
                    <div class="modal-body">
                        <div class="form-group">
                            <label class="form-label">Nombre del Departamento *</label>
                            <input type="text" name="name" class="form-control" 
                                   placeholder="ej: Ventas, Diseño, Contabilidad" required>
                        </div>
                        <div class="form-group">
                            <label class="form-label">Descripción</label>
                            <textarea name="description" class="form-control" rows="2" 
                                      placeholder="Descripción breve del departamento"></textarea>
                        </div>
                        <div class="form-group">
                            <label class="form-label">Ubicación</label>
                            <input type="text" name="location" class="form-control" 
                                   placeholder="ej: Piso 2, Edificio A">
                        </div>
                        <div class="form-group">
                            <label class="form-label">Color de Identificación</label>
                            <input type="color" name="color" class="form-control" value="#667eea">
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" onclick="closeModal('createDepartmentModal')">Cancelar</button>
                        <button type="submit" class="btn btn-primary">Crear Departamento</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- Modal: Agregar/Editar Impresora -->
    <div th:fragment="printerModals">
        <!-- Modal: Agregar Impresora -->
        <div id="addPrinterModal" class="modal">
            <div class="modal-content">
                <div class="modal-header">
                    <h3><i class="fas fa-print"></i> Agregar Nueva Impresora</h3>
                    <button class="close-modal" onclick="closeModal('addPrinterModal')">×</button>
                </div>
                <form method="post" th:action="@{/admin/add-printer}">
                    <div class="modal-body">
                        <div class="form-group">
                            <label class="form-label">Alias/Nombre *</label>
                            <input type="text" name="alias" class="form-control" 
                                   placeholder="ej: HP_LaserJet_Oficina" required>
                        </div>
                        
                        <div class="form-grid-2">
                            <div class="form-group">
                                <label class="form-label">Modelo *</label>
                                <input type="text" name="model" class="form-control" 
                                       placeholder="HP LaserJet Pro M404dn" required>
                            </div>
                            <div class="form-group">
                                <label class="form-label">Ubicación *</label>
                                <input type="text" name="location" class="form-control" 
                                       placeholder="Oficina Principal - Piso 2" required>
                            </div>
                        </div>
                        
                        <div class="form-group">
                            <label class="form-label">Dirección IP *</label>
                            <input type="text" name="ip" class="form-control" 
                                   placeholder="192.168.1.50" 
                                   pattern="^(?:[0-9]{1,3}\.){3}[0-9]{1,3}$" required>
                        </div>
                        
                        <div class="form-group">
                            <label class="form-label">URI del Dispositivo (Opcional)</label>
                            <input type="text" name="deviceUri" class="form-control" 
                                   placeholder="ipp://192.168.1.50:631/ipp/print">
                        </div>
                        
                        <div class="form-grid-2">
                            <div class="form-group">
                                <label class="form-label">Protocolo</label>
                                <select name="protocol" class="form-control">
                                    <option value="">-- Seleccionar --</option>
                                    <option value="IPP">IPP (Internet Printing Protocol)</option>
                                    <option value="LPD">LPD (Line Printer Daemon)</option>
                                    <option value="RAW">RAW (Puerto 9100)</option>
                                    <option value="SMB">SMB (Samba/Windows)</option>
                                    <option value="USB">USB</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label class="form-label">Puerto</label>
                                <input type="number" name="port" class="form-control" 
                                       placeholder="631" min="1" max="65535">
                            </div>
                        </div>
                        
                   
              
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" onclick="closeModal('addPrinterModal')">Cancelar</button>
                        <button type="submit" class="btn btn-primary">Agregar Impresora</button>
                    </div>
                </form>
            </div>
        </div>
        
        <!-- Modal: Editar Impresora -->
        <div id="editPrinterModal" class="modal">
            <div class="modal-content">
                <div class="modal-header">
                    <h3><i class="fas fa-edit"></i> Editar Impresora</h3>
                    <button class="close-modal" onclick="closeModal('editPrinterModal')">×</button>
                </div>
                <form method="post" th:action="@{/admin/edit-printer}">
                    <div class="modal-body">
                        <input type="hidden" id="editPrinterId" name="id">
                        
                        <div class="form-group">
                            <label class="form-label">Alias/Nombre *</label>
                            <input type="text" id="editPrinterAlias" name="alias" class="form-control" required>
                        </div>
                        
                        <div class="form-grid-2">
                            <div class="form-group">
                                <label class="form-label">Modelo *</label>
                                <input type="text" id="editPrinterModel" name="model" class="form-control" required>
                            </div>
                            <div class="form-group">
                                <label class="form-label">Ubicación *</label>
                                <input type="text" id="editPrinterLocation" name="location" class="form-control" required>
                            </div>
                        </div>
                        
                        <div class="form-group">
                            <label class="form-label">Dirección IP *</label>
                            <input type="text" id="editPrinterIp" name="ip" class="form-control" 
                                   pattern="^(?:[0-9]{1,3}\.){3}[0-9]{1,3}$" required>
                        </div>
                        
                        <div style="background: #f8f9fa; padding: 15px; border-radius: 8px; border-left: 4px solid #667eea; margin-top: 15px;">
                            <h4 style="margin: 0 0 10px 0; font-size: 14px; color: #667eea;">
                                <i class="fas fa-info-circle"></i> Información del Servidor IPP
                            </h4>
                            <div class="form-grid-2">
                                <div class="form-group" style="margin-bottom: 0;">
                                    <label class="form-label" style="font-size: 12px; margin-bottom: 5px;">Puerto IPP del Servidor</label>
                                    <input type="text" id="editPrinterIppPort" class="form-control" readonly 
                                           style="background: #e9ecef; font-weight: bold; color: #495057;">
                                    <small style="color: #6c757d;">Puerto asignado por el servidor</small>
                                </div>
                                <div class="form-group" style="margin-bottom: 0;">
                                    <label class="form-label" style="font-size: 12px; margin-bottom: 5px;">URL IPP del Servidor</label>
                                    <input type="text" id="editPrinterIppUrl" class="form-control" readonly 
                                           style="background: #e9ecef; font-size: 12px; color: #495057;">
                                    <small style="color: #6c757d;">URL para conectar clientes</small>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" onclick="closeModal('editPrinterModal')">Cancelar</button>
                        <button type="submit" class="btn btn-primary">Guardar Cambios</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- Modal: Progreso de Escaneo de Red -->
    <div th:fragment="scanProgressModal">
        <div id="scanProgressModal" class="modal">
            <div class="modal-content scan-modal-content">
                <div class="modal-header scan-modal-header">
                    <h3><i class="fas fa-sync fa-spin"></i> Escaneando Red...</h3>
                    <button class="btn-minimize-scan" onclick="minimizeScanModal()" title="Minimizar">
                        <i class="fas fa-minus"></i>
                    </button>
                </div>
                <div class="modal-body">
                    <div class="scan-progress-wrapper">
                        <div class="scan-progress-info">
                            <span id="scanProgress">0%</span>
                            <span id="scanDetails">Preparando escaneo...</span>
                        </div>
                        <div class="scan-progress-bar-bg">
                            <div id="progressBar" class="scan-progress-bar"></div>
                        </div>
                    </div>
                    
                    <div class="scan-stats-container">
                        <div class="scan-stats-grid-2">
                            <div>
                                <div class="scan-stat-item">Red Actual:</div>
                                <div id="currentNetwork" class="scan-stat-network">--</div>
                            </div>
                            <div>
                                <div class="scan-stat-item">Impresoras Encontradas:</div>
                                <div id="foundPrinters" class="scan-stat-printers">0</div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="scan-message-wrapper">
                        <div id="scanMessage"><i class="fas fa-hourglass-half"></i> Por favor espera...</div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button id="forceCompleteBtn" class="btn btn-danger" onclick="cancelScan()" style="display: inline-block;">
                        <i class="fas fa-stop"></i> Cancelar Escaneo
                    </button>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Modal: Configurar Redes/VLANs -->
    <div th:fragment="networkModals">
        <!-- Modal: Configurar Redes -->
        <div id="configureNetworksModal" class="modal">
            <div class="modal-content modal-networks">
                <div class="modal-header">
                    <h3><i class="fas fa-cog"></i> Configurar Rangos de Red / VLANs</h3>
                    <button class="close-modal" onclick="closeModal('configureNetworksModal')">×</button>
                </div>
                <div class="modal-body">
                    <!-- Formulario para agregar red -->
                    <div class="network-form-box">
                        <h4 class="network-form-title"><i class="fas fa-plus"></i> Agregar Nueva Red</h4>
                        <form method="post" th:action="@{/admin/add-network-range}">
                            <div class="form-grid-2">
                                <div class="form-group">
                                    <label class="form-label">Nombre *</label>
                                    <input type="text" name="name" class="form-control" 
                                           placeholder="ej: VLAN Producción" required>
                                </div>
                                <div class="form-group">
                                    <label class="form-label">Rango CIDR *</label>
                                    <input type="text" name="cidrRange" class="form-control" 
                                           placeholder="192.168.1.0/24" 
                                           pattern="^([0-9]{1,3}\.){3}[0-9]{1,3}/[0-9]{1,2}$" required>
                                </div>
                            </div>
                            <div class="form-grid-2-1">
                                <div class="form-group">
                                    <label class="form-label">Descripción</label>
                                    <input type="text" name="description" class="form-control" 
                                           placeholder="Red de producción - Piso 2">
                                </div>
                                <div class="form-group">
                                    <label class="form-label">VLAN ID</label>
                                    <input type="number" name="vlanId" class="form-control" 
                                           placeholder="10" min="1" max="4094">
                                </div>
                            </div>
                            <button type="submit" class="btn btn-primary btn-sm"><i class="fas fa-plus"></i> Agregar Red</button>
                        </form>
                    </div>
                    
                    <!-- Lista de redes -->
                    <h4 class="networks-title"><i class="fas fa-network-wired"></i> Redes Configuradas</h4>
                    <div th:if="${networkRanges == null || #lists.isEmpty(networkRanges)}" class="no-networks-message">
                        <i class="fas fa-info-circle"></i> No hay redes configuradas
                    </div>
                    <table th:unless="${networkRanges == null || #lists.isEmpty(networkRanges)}" class="data-table">
                        <thead>
                            <tr>
                                <th>Nombre</th>
                                <th>Rango CIDR</th>
                                <th>Estado</th>
                                <th>Acciones</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr th:each="net : ${networkRanges}">
                                <td><strong th:text="${net.name}">Red</strong></td>
                                <td><code th:text="${net.cidrRange}">192.168.1.0/24</code></td>
                                <td>
                                    <span th:if="${net.active}" class="badge badge-success"><i class="fas fa-check"></i> Activa</span>
                                    <span th:unless="${net.active}" class="badge badge-danger"><i class="fas fa-times"></i> Inactiva</span>
                                </td>
                                <td>
                                    <div class="action-buttons">
                                        <button class="btn btn-sm btn-primary" 
                                                th:attr="data-id=${net.id}, data-name=${net.name}, data-cidr=${net.cidrRange}, data-description=${net.description}, data-vlan=${net.vlanId}, data-active=${net.active}"
                                                onclick="openEditNetworkModal(this.dataset)"
                                                title="Editar red">
                                            <i class="fas fa-edit"></i>
                                        </button>
                                        <form method="post" th:action="@{/admin/toggle-network-range(id=${net.id})}" class="d-inline">
                                            <button type="submit" class="btn btn-sm btn-primary" title="Activar/Desactivar">
                                                <i th:class="${net.active ? 'fas fa-lock' : 'fas fa-lock-open'}"></i>
                                            </button>
                                        </form>
                                        <form method="post" th:action="@{/admin/delete-network-range(id=${net.id})}" 
                                              class="d-inline" onsubmit="return confirmDelete('esta red')">
                                            <button type="submit" class="btn btn-sm btn-danger" title="Eliminar">
                                                <i class="fas fa-trash"></i>
                                            </button>
                                        </form>
                                    </div>
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" onclick="closeModal('configureNetworksModal')">Cerrar</button>
                </div>
            </div>
        </div>

        <!-- Modal: Editar Red -->
        <div id="editNetworkModal" class="modal">
            <div class="modal-content">
                <div class="modal-header">
                    <h3><i class="fas fa-edit"></i> Editar Rango de Red</h3>
                    <button class="close-modal" onclick="closeModal('editNetworkModal')">×</button>
                </div>
                <form method="post" th:action="@{/admin/edit-network-range}">
                    <div class="modal-body">
                        <input type="hidden" id="editNetworkId" name="id">
                        
                        <div class="form-grid-2">
                            <div class="form-group">
                                <label class="form-label">Nombre *</label>
                                <input type="text" id="editNetworkName" name="name" class="form-control" 
                                       placeholder="ej: VLAN Producción" required>
                            </div>
                            <div class="form-group">
                                <label class="form-label">Rango CIDR *</label>
                                <input type="text" id="editNetworkCidr" name="cidrRange" class="form-control" 
                                       placeholder="192.168.1.0/24" 
                                       pattern="^([0-9]{1,3}\.){3}[0-9]{1,3}/[0-9]{1,2}$" required>
                            </div>
                        </div>
                        
                        <div class="form-grid-2-1">
                            <div class="form-group">
                                <label class="form-label">Descripción</label>
                                <input type="text" id="editNetworkDescription" name="description" class="form-control" 
                                       placeholder="Red de producción - Piso 2">
                            </div>
                            <div class="form-group">
                                <label class="form-label">VLAN ID</label>
                                <input type="number" id="editNetworkVlan" name="vlanId" class="form-control" 
                                       placeholder="10" min="1" max="4094">
                            </div>
                        </div>
                        
                        <div class="form-group">
                            <label class="modal-checkbox-label">
                                <input type="checkbox" id="editNetworkActive" name="active" value="true">
                                <span>Red Activa</span>
                            </label>
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" onclick="closeModal('editNetworkModal')">Cancelar</button>
                        <button type="submit" class="btn btn-primary">Guardar Cambios</button>
                    </div>
                </form>
            </div>
        </div>
    </div>
</body>
</html>
