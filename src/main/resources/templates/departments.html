<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <th:block th:replace="fragments/head :: header"/>
    <title>Gesti√≥n de Departamentos</title>
    <link rel="stylesheet" th:href="@{/css/admin-modern.css}"/>
    <style>
        .department-card {
            border: 3px solid;
            border-radius: 12px;
            padding: 1.5rem;
            margin: 1rem 0;
            background: white;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        }
        .department-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1.5rem;
            padding-bottom: 1rem;
            border-bottom: 2px solid;
        }
        .dept-section {
            margin: 1rem 0;
            padding: 1rem;
            background: #f9f9f9;
            border-radius: 8px;
        }
        .item-list {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(250px, 1fr));
            gap: 0.5rem;
            margin-top: 0.5rem;
        }
        .item-badge {
            padding: 0.5rem 1rem;
            background: white;
            border-radius: 6px;
            border: 1px solid #e0e0e0;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .mac-badge {
            font-family: 'Courier New', monospace;
            background: #f0f0f0;
            padding: 0.2rem 0.5rem;
            border-radius: 3px;
            font-size: 0.85rem;
        }
        .ip-badge {
            font-family: 'Courier New', monospace;
            background: #e3f2fd;
            padding: 0.2rem 0.5rem;
            border-radius: 3px;
            color: #1976d2;
            font-size: 0.85rem;
        }
    </style>
</head>
<body>
    <nav th:replace="fragments/nav.html :: nav"></nav>
    
    <div th:if="${success}" class="alert alert-success" style="position: fixed; top: 80px; right: 20px; z-index: 9999;">
        <span th:text="${success}"></span>
    </div>
    <div th:if="${error}" class="alert alert-error" style="position: fixed; top: 80px; right: 20px; z-index: 9999;">
        <span th:text="${error}"></span>
    </div>

    <div class="admin-container">
        <div class="admin-header">
            <h1>üè¢ Gesti√≥n de Departamentos</h1>
            <p style="margin: 0.5rem 0 0 0; color: var(--text-muted);">
                Organiza computadoras e impresoras por departamentos. Las computadoras solo ver√°n las impresoras de su departamento.
            </p>
        </div>

        <div class="stats-grid">
            <div class="stat-card">
                <div class="stat-value" th:text="${departments != null ? #lists.size(departments) : 0}">0</div>
                <div class="stat-label">Departamentos</div>
            </div>
            <div class="stat-card">
                <div class="stat-value" th:text="${unassignedComputers != null ? #lists.size(unassignedComputers) : 0}">0</div>
                <div class="stat-label">Computadoras Sin Asignar</div>
            </div>
            <div class="stat-card">
                <div class="stat-value" th:text="${allPrinters != null ? #lists.size(allPrinters) : 0}">0</div>
                <div class="stat-label">Impresoras Disponibles</div>
            </div>
        </div>

        <!-- Descubrimiento de Impresoras -->
        <div class="card" style="margin-bottom: 1rem; border: 2px solid #4caf50;">
            <div class="card-header" style="background: linear-gradient(135deg, #4caf50 0%, #2e7d32 100%); color: white;">
                <span style="font-size: 1.1rem;">üîç Descubrimiento Autom√°tico de Impresoras</span>
                <div>
                    <button class="btn btn-sm" style="background: white; color: #667eea; margin-right: 0.5rem; font-weight: bold;" 
                            onclick="openModal('configureNetworksModal')">
                        ‚öôÔ∏è Configurar Redes
                    </button>
                    <form method="post" th:action="@{/admin/discover-printers}" style="display: inline;">
                        <button type="submit" class="btn btn-sm" style="background: white; color: #4caf50; font-weight: bold;" 
                                onclick="return confirm('‚úÖ Escanear la red en busca de impresoras:\n\nüåê Redes (VLANs): 192.168.x.x, 10.0.x.x\nüñ®Ô∏è USB y Compartidas\n\n‚è±Ô∏è Tiempo estimado: 2-5 minutos\n\n¬øContinuar?')">
                            üîÑ Iniciar Escaneo
                        </button>
                    </form>
                </div>
            </div>
            <div class="card-body">
                <div style="background: #e8f5e9; padding: 1.5rem; border-radius: 8px; border-left: 4px solid #4caf50;">
                    <h4 style="margin: 0 0 1rem 0; color: #2e7d32;">üéØ ¬øQu√© detecta el escaneo?</h4>
                    <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 1rem;">
                        <div style="padding: 1rem; background: white; border-radius: 6px; box-shadow: 0 2px 4px rgba(0,0,0,0.1);">
                            <div style="font-size: 2rem; margin-bottom: 0.5rem;">üåê</div>
                            <strong>Impresoras de Red</strong>
                            <div style="font-size: 0.85rem; color: #666; margin-top: 0.3rem;">
                                Diferentes VLANs y subredes<br>
                                Puertos: RAW (9100), IPP (631), LPD (515)
                            </div>
                        </div>
                        <div style="padding: 1rem; background: white; border-radius: 6px; box-shadow: 0 2px 4px rgba(0,0,0,0.1);">
                            <div style="font-size: 2rem; margin-bottom: 0.5rem;">üîå</div>
                            <strong>Impresoras USB</strong>
                            <div style="font-size: 0.85rem; color: #666; margin-top: 0.3rem;">
                                Conectadas directamente<br>
                                A computadoras del sistema
                            </div>
                        </div>
                        <div style="padding: 1rem; background: white; border-radius: 6px; box-shadow: 0 2px 4px rgba(0,0,0,0.1);">
                            <div style="font-size: 2rem; margin-bottom: 0.5rem;">üíªüñ®Ô∏è</div>
                            <strong>Compartidas</strong>
                            <div style="font-size: 0.85rem; color: #666; margin-top: 0.3rem;">
                                Computadoras que comparten<br>
                                Sus impresoras locales
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="card">
            <div class="card-header">
                <span>üìã Departamentos</span>
                <button class="btn btn-primary btn-sm" onclick="openModal('createDepartmentModal')">
                    ‚ûï Nuevo Departamento
                </button>
            </div>
            <div class="card-body">
                <div th:if="${departments == null || #lists.isEmpty(departments)}" class="empty-state">
                    <div class="empty-state-icon">üè¢</div>
                    <p>No hay departamentos creados</p>
                    <button class="btn btn-primary" onclick="openModal('createDepartmentModal')">
                        Crear Primer Departamento
                    </button>
                </div>

                <div th:unless="${departments == null || #lists.isEmpty(departments)}">
                    <div th:each="dept : ${departments}" class="department-card" 
                         th:style="'border-color: ' + ${dept.color}">
                        
                        <div class="department-header" th:style="'border-color: ' + ${dept.color}">
                            <div>
                                <h2 style="margin: 0; display: flex; align-items: center; gap: 0.5rem;">
                                    <span th:style="'width: 20px; height: 20px; border-radius: 50%; background: ' + ${dept.color}"></span>
                                    <span th:text="${dept.name}">Departamento</span>
                                </h2>
                                <p style="margin: 0.5rem 0 0 0; color: #666;">
                                    <span th:text="${dept.description}">Descripci√≥n</span>
                                    <span th:if="${dept.location}" style="margin-left: 1rem;">
                                        üìç <span th:text="${dept.location}">Ubicaci√≥n</span>
                                    </span>
                                </p>
                            </div>
                            <form method="post" th:action="@{/admin/delete-department(id=${dept.id})}" 
                                  style="display: inline;" onsubmit="return confirm('¬øEliminar este departamento?')">
                                <button type="submit" class="btn btn-danger btn-sm">üóëÔ∏è Eliminar</button>
                            </form>
                        </div>

                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem;">
                            <!-- Computadoras -->
                            <div class="dept-section">
                                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 0.5rem;">
                                    <h3 style="margin: 0;">üíª Computadoras (<span th:text="${dept.computers != null ? #lists.size(dept.computers) : 0}">0</span>)</h3>
                                    <button class="btn btn-sm btn-primary" 
                                            th:attr="data-dept-id=${dept.id}, data-dept-name=${dept.name}"
                                            onclick="openAddComputerModal(this.dataset)">‚ûï</button>
                                </div>
                                
                                <div th:if="${dept.computers == null || #lists.isEmpty(dept.computers)}" style="color: #999; text-align: center; padding: 1rem;">
                                    Sin computadoras asignadas
                                </div>
                                
                                <div th:unless="${dept.computers == null || #lists.isEmpty(dept.computers)}" class="item-list">
                                    <div th:each="comp : ${dept.computers}" class="item-badge">
                                        <div>
                                            <div><strong th:text="${comp.name}">PC</strong></div>
                                            <span class="mac-badge" th:text="${comp.macAddress}">MAC</span>
                                        </div>
                                        <form method="post" th:action="@{/admin/remove-computer-from-dept(computerId=${comp.id})}" 
                                              style="display: inline;">
                                            <button type="submit" class="btn btn-sm btn-danger" 
                                                    style="padding: 0.2rem 0.5rem; font-size: 0.8rem;">‚úï</button>
                                        </form>
                                    </div>
                                </div>
                            </div>

                            <!-- Impresoras -->
                            <div class="dept-section">
                                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 0.5rem;">
                                    <h3 style="margin: 0;">üñ®Ô∏è Impresoras (<span th:text="${dept.printers != null ? #lists.size(dept.printers) : 0}">0</span>)</h3>
                                    <button class="btn btn-sm btn-success" 
                                            th:attr="data-dept-id=${dept.id}, data-dept-name=${dept.name}"
                                            onclick="openAssignPrinterModal(this.dataset)">‚ûï</button>
                                </div>
                                
                                <div th:if="${dept.printers == null || #lists.isEmpty(dept.printers)}" style="color: #999; text-align: center; padding: 1rem;">
                                    Sin impresoras asignadas
                                </div>
                                
                                <div th:unless="${dept.printers == null || #lists.isEmpty(dept.printers)}" class="item-list">
                                    <div th:each="printer : ${dept.printers}" class="item-badge">
                                        <div>
                                            <div><strong th:text="${printer.alias}">Printer</strong></div>
                                            <span class="ip-badge" th:text="${printer.ip}">IP</span>
                                        </div>
                                        <form method="post" th:action="@{/admin/remove-printer-from-dept(departmentId=${dept.id}, printerId=${printer.id})}" 
                                              style="display: inline;">
                                            <button type="submit" class="btn btn-sm btn-danger" 
                                                    style="padding: 0.2rem 0.5rem; font-size: 0.8rem;">‚úï</button>
                                        </form>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal: Configurar Redes/VLANs -->
    <div id="configureNetworksModal" class="modal">
        <div class="modal-content" style="max-width: 800px;">
            <div class="modal-header" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white;">
                <h3>‚öôÔ∏è Configurar Rangos de Red / VLANs</h3>
                <button class="close-modal" onclick="closeModal('configureNetworksModal')">√ó</button>
            </div>
            <div class="modal-body">
                <!-- Formulario para agregar red -->
                <div style="background: #f5f5f5; padding: 1rem; border-radius: 8px; margin-bottom: 1rem;">
                    <h4 style="margin: 0 0 1rem 0;">‚ûï Agregar Nueva Red</h4>
                    <form method="post" th:action="@{/admin/add-network-range}">
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem;">
                            <div class="form-group">
                                <label class="form-label">Nombre *</label>
                                <input type="text" name="name" class="form-control" 
                                       placeholder="ej: VLAN Producci√≥n" required>
                            </div>
                            <div class="form-group">
                                <label class="form-label">Rango CIDR *</label>
                                <input type="text" name="cidrRange" class="form-control" 
                                       placeholder="192.168.1.0/24" 
                                       pattern="^([0-9]{1,3}\.){3}[0-9]{1,3}/[0-9]{1,2}$" required>
                                <small style="color: #666;">Formato: 192.168.1.0/24</small>
                            </div>
                        </div>
                        <div style="display: grid; grid-template-columns: 2fr 1fr; gap: 1rem;">
                            <div class="form-group">
                                <label class="form-label">Descripci√≥n</label>
                                <input type="text" name="description" class="form-control" 
                                       placeholder="Red de producci√≥n - Piso 2">
                            </div>
                            <div class="form-group">
                                <label class="form-label">VLAN ID</label>
                                <input type="number" name="vlanId" class="form-control" 
                                       placeholder="10" min="1" max="4094">
                            </div>
                        </div>
                        <button type="submit" class="btn btn-primary btn-sm">‚ûï Agregar Red</button>
                    </form>
                </div>
                
                <!-- Lista de redes configuradas -->
                <h4 style="margin: 1rem 0;">üåê Redes Configuradas</h4>
                <div th:if="${networkRanges == null || #lists.isEmpty(networkRanges)}" style="text-align: center; padding: 2rem; color: #999;">
                    üö´ No hay redes configuradas. Se usar√° la red por defecto (192.168.1.0/24)
                </div>
                <table th:unless="${networkRanges == null || #lists.isEmpty(networkRanges)}" class="data-table">
                    <thead>
                        <tr>
                            <th>Nombre</th>
                            <th>Rango CIDR</th>
                            <th>VLAN</th>
                            <th>Hosts</th>
                            <th>√öltimo Escaneo</th>
                            <th>Encontradas</th>
                            <th>Estado</th>
                            <th>Acciones</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr th:each="net : ${networkRanges}">
                            <td><strong th:text="${net.name}">Red</strong></td>
                            <td><code th:text="${net.cidrRange}">192.168.1.0/24</code></td>
                            <td>
                                <span th:if="${net.vlanId != null}" 
                                      class="badge badge-info" 
                                      th:text="'VLAN ' + ${net.vlanId}">VLAN 10</span>
                                <span th:unless="${net.vlanId != null}" style="color: #999;">--</span>
                            </td>
                            <td>
                                <span th:with="transfer=${net.toTransfer()}" 
                                      th:text="${transfer.estimatedHosts}">254</span>
                            </td>
                            <td>
                                <span th:if="${net.lastScan != null}" 
                                      th:text="${#temporals.format(net.lastScan, 'dd/MM HH:mm')}">--</span>
                                <span th:unless="${net.lastScan != null}" style="color: #999;">Nunca</span>
                            </td>
                            <td>
                                <span th:if="${net.lastFoundPrinters > 0}" 
                                      class="badge badge-success" 
                                      th:text="${net.lastFoundPrinters}">0</span>
                                <span th:unless="${net.lastFoundPrinters > 0}" style="color: #999;">--</span>
                            </td>
                            <td>
                                <span th:if="${net.active}" class="badge badge-success">‚úì Activa</span>
                                <span th:unless="${net.active}" class="badge badge-danger">‚úó Inactiva</span>
                            </td>
                            <td>
                                <div class="action-buttons">
                                    <form method="post" th:action="@{/admin/toggle-network-range(id=${net.id})}" 
                                          style="display:inline;">
                                        <button type="submit" class="btn btn-sm" 
                                                th:classappend="${net.active ? 'btn-warning' : 'btn-success'}">
                                            <span th:text="${net.active ? 'üîí' : 'üîì'}"></span>
                                        </button>
                                    </form>
                                    <form method="post" th:action="@{/admin/delete-network-range(id=${net.id})}" 
                                          style="display:inline;" 
                                          onsubmit="return confirm('¬øEliminar esta red?')">
                                        <button type="submit" class="btn btn-sm btn-danger">üóëÔ∏è</button>
                                    </form>
                                </div>
                            </td>
                        </tr>
                    </tbody>
                </table>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" onclick="closeModal('configureNetworksModal')">Cerrar</button>
            </div>
        </div>
    </div>

    <!-- Modal: Crear Departamento -->
    <div id="createDepartmentModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>‚ûï Nuevo Departamento</h3>
                <button class="close-modal" onclick="closeModal('createDepartmentModal')">√ó</button>
            </div>
            <form method="post" th:action="@{/admin/create-department}">
                <div class="modal-body">
                    <div class="form-group">
                        <label class="form-label">Nombre del Departamento *</label>
                        <input type="text" name="name" class="form-control" 
                               placeholder="ej: Ventas, Dise√±o, Contabilidad" required>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Descripci√≥n</label>
                        <textarea name="description" class="form-control" rows="2" 
                                  placeholder="Descripci√≥n breve del departamento"></textarea>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Ubicaci√≥n</label>
                        <input type="text" name="location" class="form-control" 
                               placeholder="ej: Piso 2, Edificio A">
                    </div>
                    <div class="form-group">
                        <label class="form-label">Color de Identificaci√≥n</label>
                        <input type="color" name="color" class="form-control" value="#667eea">
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" onclick="closeModal('createDepartmentModal')">Cancelar</button>
                    <button type="submit" class="btn btn-primary">Crear Departamento</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Modal: Agregar Computadora -->
    <div id="addComputerModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>üíª Agregar Computadora</h3>
                <button class="close-modal" onclick="closeModal('addComputerModal')">√ó</button>
            </div>
            <form method="post" th:action="@{/admin/add-computer-to-dept}">
                <div class="modal-body">
                    <input type="hidden" id="addComputerDeptId" name="departmentId">
                    <div style="background: #f0f0f0; padding: 1rem; border-radius: 5px; margin-bottom: 1rem;">
                        <strong>Departamento:</strong> <span id="addComputerDeptName"></span>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Direcci√≥n MAC *</label>
                        <input type="text" name="macAddress" class="form-control" 
                               placeholder="AA:BB:CC:DD:EE:FF" 
                               pattern="([0-9A-Fa-f]{2}[:-]){5}([0-9A-Fa-f]{2})" required>
                        <small>Formato: XX:XX:XX:XX:XX:XX</small>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Nombre *</label>
                        <input type="text" name="name" class="form-control" 
                               placeholder="PC-Ventas-01" required>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Hostname</label>
                        <input type="text" name="hostname" class="form-control" 
                               placeholder="pc-ventas-01">
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" onclick="closeModal('addComputerModal')">Cancelar</button>
                    <button type="submit" class="btn btn-primary">Agregar</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Modal: Asignar Impresora -->
    <div id="assignPrinterModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>üñ®Ô∏è Asignar Impresora</h3>
                <button class="close-modal" onclick="closeModal('assignPrinterModal')">√ó</button>
            </div>
            <form method="post" th:action="@{/admin/assign-printer-to-dept}">
                <div class="modal-body">
                    <input type="hidden" id="assignPrinterDeptId" name="departmentId">
                    <div style="background: #f0f0f0; padding: 1rem; border-radius: 5px; margin-bottom: 1rem;">
                        <strong>Departamento:</strong> <span id="assignPrinterDeptName"></span>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Seleccionar Impresora *</label>
                        <select name="printerId" class="form-control" required>
                            <option value="">-- Seleccione una impresora --</option>
                            <option th:each="p : ${allPrinters}" th:value="${p.id}" 
                                    th:text="${p.alias + ' (' + p.ip + ') - ' + p.model}">
                                Impresora
                            </option>
                        </select>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" onclick="closeModal('assignPrinterModal')">Cancelar</button>
                    <button type="submit" class="btn btn-primary">Asignar</button>
                </div>
            </form>
        </div>
    </div>

    <footer th:replace="fragments/footer.html :: footer"></footer>

    <script th:src="@{/js/admin.js}"></script>
    
    <!-- Modal de Progreso de Escaneo -->
    <div id="scanProgressModal" class="modal" style="display: none;">
        <div class="modal-content" style="max-width: 600px;">
            <div class="modal-header" style="background: linear-gradient(135deg, #4caf50 0%, #2e7d32 100%); color: white;">
                <h3>üîç Escaneando Red en Busca de Impresoras...</h3>
            </div>
            <div class="modal-body">
                <div style="margin-bottom: 1rem;">
                    <div style="display: flex; justify-content: space-between; margin-bottom: 0.5rem;">
                        <span id="scanProgress">0%</span>
                        <span id="scanDetails">Preparando escaneo...</span>
                    </div>
                    <div style="width: 100%; height: 30px; background: #e0e0e0; border-radius: 15px; overflow: hidden;">
                        <div id="progressBar" style="width: 0%; height: 100%; background: linear-gradient(90deg, #4caf50 0%, #8bc34a 100%); transition: width 0.3s ease;"></div>
                    </div>
                </div>
                
                <div style="background: #f5f5f5; padding: 1rem; border-radius: 5px; margin: 1rem 0;">
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem;">
                        <div>
                            <div style="font-size: 0.85rem; color: #666;">Red Actual:</div>
                            <div id="currentNetwork" style="font-weight: bold; color: #2e7d32;">--</div>
                        </div>
                        <div>
                            <div style="font-size: 0.85rem; color: #666;">Impresoras Encontradas:</div>
                            <div id="foundPrinters" style="font-weight: bold; color: #1976d2; font-size: 1.5rem;">0</div>
                        </div>
                        <div>
                            <div style="font-size: 0.85rem; color: #666;">Hosts Escaneados:</div>
                            <div id="hostsScanned" style="font-weight: bold;">0 / 0</div>
                        </div>
                        <div>
                            <div style="font-size: 0.85rem; color: #666;">Tiempo Restante:</div>
                            <div id="timeRemaining" style="font-weight: bold;">Calculando...</div>
                        </div>
                    </div>
                </div>
                
                <div style="text-align: center; color: #666; font-size: 0.9rem;">
                    <div id="scanMessage">‚è≥ Por favor espera, esto puede tomar varios minutos...</div>
                    <button id="forceCompleteBtn" class="btn btn-sm btn-warning" 
                            style="margin-top: 1rem; display: none;"
                            onclick="forceComplete()">
                        ‚ö†Ô∏è Forzar Completar (si se qued√≥ atascado)
                    </button>
                </div>
            </div>
        </div>
    </div>
    
    <script>
        function openAddComputerModal(data) {
            document.getElementById('addComputerDeptId').value = data.deptId;
            document.getElementById('addComputerDeptName').textContent = data.deptName;
            openModal('addComputerModal');
        }

        function openAssignPrinterModal(data) {
            document.getElementById('assignPrinterDeptId').value = data.deptId;
            document.getElementById('assignPrinterDeptName').textContent = data.deptName;
            openModal('assignPrinterModal');
        }

        // Auto-cerrar alertas
        document.addEventListener('DOMContentLoaded', function() {
            const alerts = document.querySelectorAll('.alert');
            alerts.forEach(alert => {
                setTimeout(() => {
                    alert.style.opacity = '0';
                    setTimeout(() => alert.remove(), 300);
                }, 5000);
            });
            
            // Verificar si hay escaneo en progreso
            const urlParams = new URLSearchParams(window.location.search);
            if (urlParams.get('scanning') === 'true') {
                startScanMonitoring();
            }
        });
        
        let scanInterval = null;
        let lastProgress = 0;
        let stuckCount = 0;
        
        function forceComplete() {
            clearInterval(scanInterval);
            document.getElementById('progressBar').style.width = '100%';
            document.getElementById('scanProgress').textContent = '100%';
            document.getElementById('scanMessage').innerHTML = 
                '‚úÖ <strong>Escaneo Finalizado</strong><br>Recargando p√°gina...';
            setTimeout(() => {
                window.location.href = '/admin/';
            }, 2000);
        }
        
        function startScanMonitoring() {
            // Mostrar modal de progreso
            document.getElementById('scanProgressModal').style.display = 'block';
            
            // Actualizar cada segundo
            scanInterval = setInterval(updateScanProgress, 1000);
            
            // Primera actualizaci√≥n inmediata
            updateScanProgress();
        }
        
        function updateScanProgress() {
            fetch('/admin/scan-status')
                .then(response => response.json())
                .then(data => {
                    if (!data.scanning && data.progress === 0) {
                        // No hay escaneo activo
                        return;
                    }
                    
                    // Actualizar barra de progreso
                    document.getElementById('progressBar').style.width = data.progress + '%';
                    document.getElementById('scanProgress').textContent = data.progress + '%';
                    
                    // Actualizar detalles
                    document.getElementById('currentNetwork').textContent = data.currentNetwork || 'Iniciando...';
                    document.getElementById('foundPrinters').textContent = data.foundPrinters;
                    document.getElementById('hostsScanned').textContent = 
                        data.scannedHosts + ' / ' + data.totalHosts;
                    
                    // Tiempo restante
                    if (data.estimatedRemaining > 0) {
                        const minutes = Math.floor(data.estimatedRemaining / 60);
                        const seconds = data.estimatedRemaining % 60;
                        document.getElementById('timeRemaining').textContent = 
                            minutes + 'm ' + seconds + 's';
                    } else {
                        document.getElementById('timeRemaining').textContent = 'Calculando...';
                    }
                    
                    // Detectar si se qued√≥ atascado
                    if (data.progress === lastProgress && data.progress > 95 && data.progress < 100) {
                        stuckCount++;
                        if (stuckCount > 10) { // 10 segundos atascado
                            document.getElementById('forceCompleteBtn').style.display = 'inline-block';
                        }
                    } else {
                        stuckCount = 0;
                        lastProgress = data.progress;
                        document.getElementById('forceCompleteBtn').style.display = 'none';
                    }
                    
                    // Actualizar mensaje
                    if (data.scanning) {
                        document.getElementById('scanDetails').textContent = 
                            'Escaneando ' + data.currentNetwork + '...';
                    } else if (data.progress >= 100 || (!data.scanning && data.progress > 0)) {
                        // Escaneo completado
                        document.getElementById('scanMessage').innerHTML = 
                            '‚úÖ <strong>Escaneo Completado!</strong><br>' +
                            'Encontradas ' + data.foundPrinters + ' impresoras.<br>' +
                            'Recargando p√°gina...';
                        
                        clearInterval(scanInterval);
                        
                        // Recargar p√°gina despu√©s de 3 segundos
                        setTimeout(() => {
                            window.location.href = '/admin/';
                        }, 3000);
                    }
                })
                .catch(error => {
                    console.error('Error al obtener estado del escaneo:', error);
                });
        }
    </script>
</body>
</html>
